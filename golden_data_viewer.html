<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CardioWatch 287-2B — Golden Data Viewer</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #1a73e8;
  --accent-light: #e8f0fe;
  --text: #202124;
  --text2: #5f6368;
  --border: #dadce0;
  --green: #0d652d;
  --green-bg: #e6f4ea;
  --orange: #e37400;
  --orange-bg: #fef7e0;
  --red: #c5221f;
  --red-bg: #fce8e6;
  --blue: #1967d2;
  --blue-bg: #e8f0fe;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
header { background: linear-gradient(135deg, #1a237e 0%, #1565c0 100%); color: #fff; padding: 32px 40px; }
header h1 { font-size: 28px; font-weight: 600; }
header p { color: #bbdefb; margin-top: 6px; font-size: 15px; }

.controls { background: var(--card); border-bottom: 2px solid var(--border); padding: 20px 40px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,.06); }
.control-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.control-row label { font-size: 14px; font-weight: 500; color: var(--text2); min-width: 100px; }
.control-row select { flex: 1; max-width: 500px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px; background: white; cursor: pointer; transition: border-color .15s; }
.control-row select:hover { border-color: var(--accent); }
.control-row select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.btn { padding: 10px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .15s; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: #1557b0; box-shadow: 0 2px 8px rgba(26,115,232,.3); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }

.content { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

.description-card { background: var(--orange-bg); border: 1px solid var(--orange); border-left: 4px solid var(--orange); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.description-card h2 { font-size: 18px; color: var(--orange); margin-bottom: 8px; font-weight: 600; }
.description-card p { color: var(--text); font-size: 14px; line-height: 1.6; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
.stat-card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
.stat-card .value { font-size: 32px; font-weight: 700; color: var(--accent); }

.graph-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.graph-card .header { background: var(--accent-light); color: var(--accent); padding: 14px 20px; font-weight: 600; font-size: 16px; border-bottom: 2px solid var(--border); }
.graph-card .body { padding: 0; }

.loading { text-align: center; padding: 60px 20px; }
.loading .spinner { width: 48px; height: 48px; border: 4px solid var(--accent-light); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading p { font-size: 16px; color: var(--text2); }

.error-card { background: var(--red-bg); border: 1px solid var(--red); border-left: 4px solid var(--red); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.error-card h3 { color: var(--red); font-size: 16px; margin-bottom: 8px; }
.error-card p { color: var(--text); font-size: 14px; }

.quality-legend { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 20px; background: var(--bg); border-radius: 8px; margin-bottom: 16px; }
.quality-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text2); }
.quality-dot { width: 12px; height: 12px; border-radius: 50%; }

footer { text-align: center; padding: 32px 20px; color: var(--text2); font-size: 13px; border-top: 1px solid var(--border); margin-top: 40px; }

@media(max-width:768px) {
  .content { padding: 20px; }
  header { padding: 20px; }
  .controls { padding: 16px 20px; }
  .control-row { flex-direction: column; align-items: stretch; }
  .control-row label { min-width: unset; }
  .control-row select { max-width: 100%; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>CardioWatch 287-2B &mdash; Golden Data Viewer</h1>
  <p>Interactive Signal Analysis &bull; 40 Clinical Scenarios &bull; Simulator Test Suite</p>
</header>

<div class="controls">
  <div class="control-row">
    <label for="scenarioSelect">Clinical Scenario:</label>
    <select id="scenarioSelect">
      <option value="">-- Select a clinical test scenario --</option>
    </select>
    <button class="btn btn-primary" id="loadBtn" onclick="loadScenario()">Load Data</button>
  </div>
</div>

<div class="content">
  <div id="description" style="display:none;">
    <div class="description-card">
      <h2 id="descTitle"></h2>
      <p id="descText"></p>
    </div>
  </div>

  <div id="stats" class="stats-grid" style="display:none;">
    <div class="stat-card">
      <div class="label">Duration</div>
      <div class="value" id="statDuration">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg HR</div>
      <div class="value" id="statHR">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg SpO2</div>
      <div class="value" id="statSpO2">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Records</div>
      <div class="value" id="statRecords">--</div>
    </div>
  </div>

  <div id="loading" style="display:none;">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading clinical data...</p>
    </div>
  </div>

  <div id="error" style="display:none;">
    <div class="error-card">
      <h3>Error Loading Data</h3>
      <p id="errorText"></p>
    </div>
  </div>

  <div id="graphs" style="display:none;">
    <div class="quality-legend">
      <div class="quality-item"><div class="quality-dot" style="background:#cccccc"></div>Q=0 No Quality</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ff6b6b"></div>Q=1 Low</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ffd93d"></div>Q=2 Medium</div>
      <div class="quality-item"><div class="quality-dot" style="background:#6bcf7f"></div>Q=3 Good</div>
      <div class="quality-item"><div class="quality-dot" style="background:#4ecdc4"></div>Q=4 Excellent</div>
    </div>

    <div class="graph-card">
      <div class="header">PPG Signals &mdash; Multi-wavelength (Green 530nm, Red 660nm, IR 940nm)</div>
      <div class="body"><div id="ppgGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Accelerometer &mdash; 3-Axis Motion (X, Y, Z)</div>
      <div class="body"><div id="accGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Heart Rate (BPM) &mdash; Color-coded by Quality Score</div>
      <div class="body"><div id="bpmGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">SpO2 (%) &mdash; Blood Oxygen Saturation by Quality Score</div>
      <div class="body"><div id="spo2Graph"></div></div>
    </div>
  </div>
</div>

<footer>
  <p>CardioWatch 287-2B by Corsano Health &bull; Firmware Simulator &bull; Golden Test Data Suite</p>
</footer>

<script>
// Scenario descriptions
const scenarios = {
  '01_normal_rest': {
    name: 'Normal Rest',
    description: 'Healthy adult at rest. HR: 60-80 bpm, SpO2: 98%, regular sinus rhythm. Clean PPG signal with good perfusion.',
    events: []
  },
  '02_elderly_rest': {
    name: 'Elderly Rest',
    description: 'Elderly patient at rest. HR: 70-85 bpm, SpO2: 97%, may show slightly irregular baseline due to age-related changes.',
    events: []
  },
  '03_athlete_rest': {
    name: 'Athlete Rest',
    description: 'Athletic individual at rest. HR: 50-60 bpm (bradycardia), SpO2: 99%, strong cardiac output, high HRV.',
    events: []
  },
  '04_hypoxia_mild': {
    name: 'Mild Hypoxia',
    description: 'Mild oxygen desaturation. SpO2: 90-94%, HR increases to compensate (80-100 bpm). Simulates high altitude or mild respiratory issue.',
    events: []
  },
  '05_hypoxia_moderate': {
    name: 'Moderate Hypoxia',
    description: 'Moderate hypoxia. SpO2: 85-89%, HR: 100-120 bpm, compensatory tachycardia. May see PPG amplitude reduction.',
    events: []
  },
  '06_hypoxia_severe': {
    name: 'Severe Hypoxia',
    description: 'Severe hypoxia requiring intervention. SpO2: <85%, HR: 120-150 bpm, weak PPG signal, clinical emergency.',
    events: []
  },
  '07_walking': {
    name: 'Walking Activity',
    description: 'Moderate walking pace. HR: 100-120 bpm, SpO2: 96-98%, ACC shows rhythmic motion artifacts. Tests motion rejection.',
    events: []
  },
  '08_running': {
    name: 'Running Activity',
    description: 'Running exercise. HR: 150-180 bpm, SpO2 difficult to measure due to motion, large ACC artifacts. Tests algorithm limits.',
    events: []
  },
  '09_wrist_movement': {
    name: 'Wrist Movement',
    description: 'Deliberate wrist movements without body motion. HR: 70-90 bpm, PPG artifacts, tests motion detection algorithm.',
    events: []
  },
  '10_af_rapid': {
    name: 'Rapid Atrial Fibrillation',
    description: 'AF with rapid ventricular response. HR: 120-160 bpm irregular, no P-waves, irregular PPG intervals. R-R varies wildly.',
    events: []
  },
  '15_psvt_episodes': {
    name: 'PSVT Episodes',
    description: 'Paroxysmal supraventricular tachycardia. Sudden HR jumps from 70 to 160+ bpm, then back. Tests transient arrhythmia detection.',
    events: [{time: 900, label: 'PSVT Onset'}, {time: 1800, label: 'Return to Sinus'}]
  },
  '16_vt_monomorphic': {
    name: 'Ventricular Tachycardia',
    description: 'Sustained VT. HR: 150-200 bpm, wide QRS, hemodynamically unstable. PPG may show reduced amplitude.',
    events: []
  },
  '17_torsades': {
    name: 'Torsades de Pointes',
    description: 'Polymorphic VT with twisting QRS. HR: 200-250 bpm, unstable rhythm, high risk of VF. Life-threatening arrhythmia.',
    events: []
  },
  '21_vf_from_sinus': {
    name: 'VF from Sinus',
    description: 'Normal sinus rhythm degenerating into ventricular fibrillation. PPG signal collapses, no effective cardiac output. CRITICAL EVENT.',
    events: [{time: 1800, label: 'VF Onset - Cardiac Arrest'}]
  },
  '22_vt_to_vf': {
    name: 'VT to VF Progression',
    description: 'VT deteriorating to VF. Progressive loss of organized rhythm and perfusion. Critical situation requiring immediate intervention.',
    events: [{time: 1200, label: 'VT Onset'}, {time: 2400, label: 'VF - Cardiac Arrest'}]
  },
  '23_asystole': {
    name: 'Asystole',
    description: 'Complete cardiac standstill. No electrical activity, no mechanical contraction. Flat PPG signal. Requires immediate CPR.',
    events: [{time: 1200, label: 'Cardiac Arrest - Asystole'}]
  },
  '24_pea': {
    name: 'Pulseless Electrical Activity',
    description: 'Electrical activity present but no mechanical output. ECG shows rhythm but no palpable pulse, no PPG signal.',
    events: [{time: 1500, label: 'Loss of Pulse - PEA'}]
  },
  '32_hemorrhagic_shock': {
    name: 'Hemorrhagic Shock',
    description: 'Severe blood loss. Progressive tachycardia (HR >120 bpm), weak PPG amplitude, compensatory mechanisms failing.',
    events: []
  },
  '33_hypothermia_32C': {
    name: 'Moderate Hypothermia (32°C)',
    description: 'Core temp 32°C. Bradycardia (HR 50-70 bpm), prolonged intervals, J-waves, shivering artifacts initially.',
    events: []
  },
  '34_hypothermia_28C': {
    name: 'Severe Hypothermia (28°C)',
    description: 'Core temp 28°C. Severe bradycardia (HR <50 bpm), high risk of VF, barely detectable perfusion.',
    events: []
  },
  '35_sleep_apnea': {
    name: 'Sleep Apnea',
    description: 'Obstructive sleep apnea cycles. Periodic SpO2 drops (85-95%), compensatory HR increases, cyclic pattern every 60-90s.',
    events: []
  },
  '40_co_poisoning': {
    name: 'Carbon Monoxide Poisoning',
    description: 'CO poisoning. SpO2 reads falsely high (carboxyhemoglobin), HR may be normal or elevated. Dangerous false readings.',
    events: []
  }
};

// Populate dropdown
const scenarioSelect = document.getElementById('scenarioSelect');
Object.keys(scenarios).sort().forEach(key => {
  const option = document.createElement('option');
  option.value = key;
  option.textContent = `${scenarios[key].name} (${key})`;
  scenarioSelect.appendChild(option);
});

let currentData = null;

async function loadScenario() {
  const scenario = scenarioSelect.value;
  if (!scenario) {
    alert('Please select a scenario');
    return;
  }

  // Show loading
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error').style.display = 'none';
  document.getElementById('graphs').style.display = 'none';
  document.getElementById('description').style.display = 'none';
  document.getElementById('stats').style.display = 'none';

  try {
    // Load JSON data (for GitHub Pages compatibility)
    const jsonPath = `data/${scenario}.json`;
    const response = await fetch(jsonPath);
    if (!response.ok) throw new Error(`Failed to load ${jsonPath}`);
    const data = await response.json();

    currentData = {
      ppgGreen: data.ppg_green || [],
      ppgRed: data.ppg_red || [],
      ppgIR: data.ppg_ir || [],
      acc: data.acc || [],
      activityRecords: data.activity_records || [],
      scenario: scenarios[scenario]
    };

    // Show description
    document.getElementById('descTitle').textContent = currentData.scenario.name;
    document.getElementById('descText').textContent = currentData.scenario.description;
    document.getElementById('description').style.display = 'block';

    // Calculate stats
    updateStats(currentData.activityRecords);

    // Plot graphs
    plotAllGraphs();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('graphs').style.display = 'block';
    document.getElementById('stats').style.display = 'grid';

  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorText').textContent = error.message;
    console.error(error);
  }
}

function updateStats(activityRecords) {
  const duration = activityRecords.length;
  const hrValues = activityRecords.map(r => parseInt(r.bpm)).filter(v => v > 0);
  const spo2Values = activityRecords.map(r => parseInt(r.spo2)).filter(v => v > 0);

  const avgHR = hrValues.length > 0 ? Math.round(hrValues.reduce((a, b) => a + b) / hrValues.length) : 0;
  const avgSpO2 = spo2Values.length > 0 ? Math.round(spo2Values.reduce((a, b) => a + b) / spo2Values.length) : 0;

  document.getElementById('statDuration').textContent = `${duration} min`;
  document.getElementById('statHR').textContent = avgHR > 0 ? `${avgHR}` : '--';
  document.getElementById('statSpO2').textContent = avgSpO2 > 0 ? `${avgSpO2}%` : '--';
  document.getElementById('statRecords').textContent = duration;
}

function plotAllGraphs() {
  plotPPG(currentData.ppgGreen, currentData.ppgRed, currentData.ppgIR);
  plotACC(currentData.acc);
  plotBPM(currentData.activityRecords);
  plotSpO2(currentData.activityRecords);
  synchronizeGraphs();
}

function plotPPG(green, red, ir) {
  // Normalize time to start from 0
  const t0 = green.length > 0 ? parseInt(green[0].timestamp) / 1000 : 0;

  const traces = [
    {
      x: green.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: green.map(r => parseInt(r.value)),
      name: 'Green (530nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#00cc00', width: 1}
    },
    {
      x: red.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: red.map(r => parseInt(r.value)),
      name: 'Red (660nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff0000', width: 1}
    },
    {
      x: ir.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: ir.map(r => parseInt(r.value)),
      name: 'IR (940nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#cc00cc', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'PPG Value (ADC counts)'},
    height: 400,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('ppgGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotACC(acc) {
  // Normalize time to start from 0
  const t0 = acc.length > 0 ? parseInt(acc[0].timestamp) / 1000 : 0;

  const traces = [
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accX)),
      name: 'ACC X',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff6b6b', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accY)),
      name: 'ACC Y',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#4ecdc4', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accZ)),
      name: 'ACC Z',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#45b7d1', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'Acceleration (counts)'},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('accGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotBPM(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.bpm_q) === q && parseInt(r.bpm) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.bpm)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [0, 200],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'Heart Rate (bpm)', range: [0, 200]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('bpmGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotSpO2(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.spo2_q) === q && parseInt(r.spo2) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.spo2)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [75, 105],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'SpO2 (%)', range: [75, 105]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('spo2Graph', traces, layout, {responsive: true, displayModeBar: false});
}

function synchronizeGraphs() {
  const graphIds = ['ppgGraph', 'accGraph', 'bpmGraph', 'spo2Graph'];

  graphIds.forEach(id => {
    const graph = document.getElementById(id);

    graph.on('plotly_relayout', (eventdata) => {
      if (eventdata['xaxis.range[0]'] !== undefined && eventdata['xaxis.range[1]'] !== undefined) {
        const xrange = [eventdata['xaxis.range[0]'], eventdata['xaxis.range[1]']];
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.range': xrange});
          }
        });
      } else if (eventdata['xaxis.autorange'] === true) {
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.autorange': true});
          }
        });
      }
    });
  });
}
</script>
</body>
</html>
