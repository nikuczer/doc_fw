<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CardioWatch 287-2B ‚Äî Golden Data Viewer</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #1a73e8;
  --accent-light: #e8f0fe;
  --text: #202124;
  --text2: #5f6368;
  --border: #dadce0;
  --green: #0d652d;
  --green-bg: #e6f4ea;
  --orange: #e37400;
  --orange-bg: #fef7e0;
  --red: #c5221f;
  --red-bg: #fce8e6;
  --blue: #1967d2;
  --blue-bg: #e8f0fe;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
header { background: linear-gradient(135deg, #1a237e 0%, #1565c0 100%); color: #fff; padding: 32px 40px; }
header h1 { font-size: 28px; font-weight: 600; }
header p { color: #bbdefb; margin-top: 6px; font-size: 15px; }

.controls { background: var(--card); border-bottom: 2px solid var(--border); padding: 20px 40px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,.06); }
.control-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.control-row label { font-size: 14px; font-weight: 500; color: var(--text2); min-width: 100px; }
.control-row select { flex: 1; max-width: 500px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px; background: white; cursor: pointer; transition: border-color .15s; }
.control-row select:hover { border-color: var(--accent); }
.control-row select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.btn { padding: 10px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .15s; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: #1557b0; box-shadow: 0 2px 8px rgba(26,115,232,.3); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }

.content { padding: 32px 40px; max-width: 1400px; margin: 0 auto; }

.description-card { background: var(--orange-bg); border: 1px solid var(--orange); border-left: 4px solid var(--orange); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.description-card h2 { font-size: 18px; color: var(--orange); margin-bottom: 8px; font-weight: 600; }
.description-card p { color: var(--text); font-size: 14px; line-height: 1.6; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
.stat-card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
.stat-card .value { font-size: 32px; font-weight: 700; color: var(--accent); }

.graph-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.graph-card .header { background: var(--accent-light); color: var(--accent); padding: 14px 20px; font-weight: 600; font-size: 16px; border-bottom: 2px solid var(--border); }
.graph-card .body { padding: 0; }

.loading { text-align: center; padding: 60px 20px; }
.loading .spinner { width: 48px; height: 48px; border: 4px solid var(--accent-light); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading p { font-size: 16px; color: var(--text2); }

.error-card { background: var(--red-bg); border: 1px solid var(--red); border-left: 4px solid var(--red); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.error-card h3 { color: var(--red); font-size: 16px; margin-bottom: 8px; }
.error-card p { color: var(--text); font-size: 14px; }

.quality-legend { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 20px; background: var(--bg); border-radius: 8px; margin-bottom: 16px; }
.quality-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text2); }
.quality-dot { width: 12px; height: 12px; border-radius: 50%; }

footer { text-align: center; padding: 32px 20px; color: var(--text2); font-size: 13px; border-top: 1px solid var(--border); margin-top: 40px; }

@media(max-width:768px) {
  .content { padding: 20px; }
  header { padding: 20px; }
  .controls { padding: 16px 20px; }
  .control-row { flex-direction: column; align-items: stretch; }
  .control-row label { min-width: unset; }
  .control-row select { max-width: 100%; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>CardioWatch 287-2B &mdash; Golden Data Viewer</h1>
  <p>Interactive Signal Analysis &bull; 40 Clinical Scenarios &bull; Simulator Test Suite</p>
</header>

<div style="background: white; border-bottom: 1px solid var(--border); padding: 32px 40px;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h2 style="font-size: 20px; font-weight: 600; color: var(--text); margin-bottom: 16px;">üî¨ Firmware Validation Pipeline</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 20px;">

      <div style="background: var(--blue-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--blue);">
        <div style="font-weight: 600; color: var(--blue); margin-bottom: 8px; font-size: 15px;">üìä 1. Golden Data Generation</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Python script (<code>generate.py</code>) generates 40 clinical scenarios with synthetic PPG (Green/Red/IR) and ACC signals at 32 Hz. Each scenario simulates specific physiological conditions (rest, hypoxia, arrhythmias, cardiac arrest, etc.) based on clinical signal guide specifications.
        </div>
      </div>

      <div style="background: var(--green-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--green);">
        <div style="font-weight: 600; color: var(--green); margin-bottom: 8px; font-size: 15px;">‚öôÔ∏è 2. C Simulator Execution</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          C simulator (<code>sim_api.c</code>) reads CSV data and feeds it to REAL firmware algorithms. Uses minimal stubs only for hardware HAL (nRF52840, MAX86178, LIS2DW12). Algorithms like SpO2, HR detection, movement detection run with actual production code.
        </div>
      </div>

      <div style="background: var(--orange-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--orange);">
        <div style="font-weight: 600; color: var(--orange); margin-bottom: 8px; font-size: 15px;">üîß 3. Stub Architecture</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Philosophy: Keep REAL implementations, stub ONLY what's necessary. Real algorithms: <code>mmt_spo2.c</code>, <code>mmt_hrm_process.c</code>, <code>mmt_idle_detection.c</code>. Stubbed: hardware drivers, BLE, flash storage. This validates actual firmware behavior, not fake logic.
        </div>
      </div>

      <div style="background: var(--accent-light); padding: 20px; border-radius: 10px; border-left: 4px solid var(--accent);">
        <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px; font-size: 15px;">üìà 4. Output & Visualization</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Simulator outputs <code>activity_records.csv</code> (1-minute vital signs: HR, SpO2, quality scores). Python script downsamples data (32Hz‚Üí1Hz) and converts to JSON for GitHub Pages. This viewer provides interactive analysis with synchronized graphs and AI insights.
        </div>
      </div>

    </div>

    <div style="margin-top: 20px; padding: 16px 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%); border-radius: 8px; border: 1px solid var(--border);">
      <div style="font-size: 13px; line-height: 1.7; color: var(--text2);">
        <strong style="color: var(--text);">Key Design Principle:</strong> The simulator runs production firmware algorithms against synthetic clinical data to validate correctness across 40 physiological scenarios. This approach catches algorithm bugs early (SpO2 calibration, movement rejection, arrhythmia detection) before hardware testing. Results are version-controlled and web-accessible for continuous validation.
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <div class="control-row">
    <label for="scenarioSelect">Clinical Scenario:</label>
    <select id="scenarioSelect">
      <option value="">-- Select a clinical test scenario --</option>
    </select>
    <button class="btn btn-primary" id="loadBtn" onclick="loadScenario()">Load Data</button>
  </div>
</div>

<div class="content">
  <div id="description" style="display:none;">
    <div class="description-card">
      <h2 id="descTitle"></h2>
      <p id="descText"></p>
    </div>
  </div>

  <div id="stats" class="stats-grid" style="display:none;">
    <div class="stat-card">
      <div class="label">Duration</div>
      <div class="value" id="statDuration">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg HR</div>
      <div class="value" id="statHR">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg SpO2</div>
      <div class="value" id="statSpO2">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Records</div>
      <div class="value" id="statRecords">--</div>
    </div>
  </div>

  <div id="loading" style="display:none;">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading clinical data...</p>
    </div>
  </div>

  <div id="error" style="display:none;">
    <div class="error-card">
      <h3>Error Loading Data</h3>
      <p id="errorText"></p>
    </div>
  </div>

  <div id="graphs" style="display:none;">
    <div class="quality-legend">
      <div class="quality-item"><div class="quality-dot" style="background:#cccccc"></div>Q=0 No Quality</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ff6b6b"></div>Q=1 Low</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ffd93d"></div>Q=2 Medium</div>
      <div class="quality-item"><div class="quality-dot" style="background:#6bcf7f"></div>Q=3 Good</div>
      <div class="quality-item"><div class="quality-dot" style="background:#4ecdc4"></div>Q=4 Excellent</div>
    </div>

    <div class="graph-card">
      <div class="header">PPG Signals &mdash; Multi-wavelength (Green 530nm, Red 660nm, IR 940nm)</div>
      <div class="body"><div id="ppgGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Accelerometer &mdash; 3-Axis Motion (X, Y, Z)</div>
      <div class="body"><div id="accGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Heart Rate (BPM) &mdash; Color-coded by Quality Score</div>
      <div class="body"><div id="bpmGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">SpO2 (%) &mdash; Blood Oxygen Saturation by Quality Score</div>
      <div class="body"><div id="spo2Graph"></div></div>
    </div>

    <div class="graph-card" style="margin-top: 32px;">
      <div class="header" style="background: linear-gradient(135deg, #1a237e 0%, #1565c0 100%); color: white;">ü§ñ AI Analysis of Output Data + Logs</div>
      <div class="body" style="padding: 24px;">
        <div id="aiAnalysis" style="line-height: 1.8; font-size: 14px; color: var(--text);"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>CardioWatch 287-2B by Corsano Health &bull; Firmware Simulator &bull; Golden Test Data Suite</p>
</footer>

<script>
// Scenario descriptions from clinical signal guide
const scenarios = {
  '01_normal_rest': {
    name: 'Normal Rest - Healthy Subject',
    description: 'Reference hemodynamic profile: HR 60-80 bpm (RR interval 750-1000 ms), SpO2 96-100%, BP 110-130/70-85 mmHg. Expected morphology: regular well-defined pulse, AC/DC ratio 1-3%, fast upstroke (100-150 ms), sharp systolic peak, visible dicrotic notch. Respiratory sinus arrhythmia present (3-8 bpm modulation). Stable R ratio 0.5-0.7. ACC quasi-static ~1g, micro-variations <0.02g.',
    events: []
  },
  '02_elderly_rest': {
    name: 'Rest - Elderly Subject (70 yrs)',
    description: 'Elderly patient at rest with age-related cardiovascular changes. HR typically 70-85 bpm. May show attenuated dicrotic notch due to arterial stiffening. More prominent diastolic wave (arterial stiffness). Inter-pulse amplitude variability may be slightly higher. Respiratory modulation may be reduced. SpO2 typically 95-98%. Some isolated premature beats may occur (<1% of beats).',
    events: []
  },
  '03_athlete_rest': {
    name: 'Rest - Athletic Subject',
    description: 'Athletic individual at rest showing training bradycardia. HR 40-55 bpm with prolonged RR interval >1000 ms. Increased PPG amplitude (prolonged diastolic filling allows greater stroke volume). Well-visible dicrotic notch due to good arterial compliance. High HRV (SDNN 50-100+ ms). Strong cardiac output. Extended diastolic phase. SpO2 99-100%. Signal descends almost to baseline before next upstroke.',
    events: []
  },
  '04_hypoxia_mild': {
    name: 'Mild Hypoxia (SpO2 90-95%)',
    description: 'Clinical context: early respiratory failure, moderate altitude (2500-3500m), stable COPD, early pneumonia. R ratio increases to 0.8-1.0 (AC Red amplitude increases as deoxyhemoglobin concentration rises). Mild compensatory tachycardia 80-100 bpm due to sympathetic activation. AC Green amplitude may be normal or slightly decreased. Respiratory rate increased to 18-25 cycles/min (compensatory tachypnea), visible in PPG envelope modulation. Pulse morphology may remain normal.',
    events: []
  },
  '05_hypoxia_moderate': {
    name: 'Moderate Hypoxia (SpO2 80-90%)',
    description: 'Clinical context: acute respiratory failure, pulmonary embolism, severe asthma attack, pneumothorax, high altitude (>4000m) without acclimatization. R ratio 1.0-1.4. Tachycardia 100-130 bpm, RR interval shortened to 460-600 ms. Decreased HRV (RMSSD <15 ms) due to sympathetic predominance. AC amplitude may decrease due to compensatory peripheral vasoconstriction (output redistribution to vital organs). DC decreases as total peripheral blood volume reduces. Signal quality may degrade. Respiratory rate 25-35 cycles/min with more pronounced PPG modulation. Possible fine tremors (0.02-0.05g) in ACC if patient in distress.',
    events: []
  },
  '06_hypoxia_severe': {
    name: 'Severe Hypoxia (SpO2 <80%)',
    description: 'Clinical context: acute respiratory distress, ARDS, partial drowning, airway obstruction. CRITICAL CONDITION. R ratio >1.5 (can reach 2.0). Severe tachycardia 130-160+ bpm, then terminal bradycardia if hypoxia persists (myocardial failure, loss of sympathetic tone - extreme severity sign). Very low AC amplitude (intense vasoconstriction, can drop 60-80% vs normal). Deformed pulse wave: disappearance of dicrotic notch due to hypotension and vasoconstriction. Increased inter-pulse variability (hemodynamic instability). Possible pulsus alternans (regular alternation strong/weak pulses = severe LV failure). ACC: possible agitation (0.1-0.5g) initially, progressive immobility if LOC, possible hypoxic seizures (5-8 Hz, >1g bursts, 10-60s).',
    events: []
  },
  '07_walking': {
    name: 'Normal Walking (4-5 km/h)',
    description: 'Walking at comfortable speed (cadence 1.8-2.2 Hz). ACC: regular oscillations 0.3-1.5g around 1g. Y-axis (forearm) shows dominant walking cadence ~2Hz. Z-axis shows heel strike impacts. Spectrum: fundamental peak at step frequency with harmonics. PPG severely contaminated by motion artifacts: (a) sensor lift-off, (b) contact pressure variation, (c) venous blood movement (muscle pump), (d) arteriole deformation by tendons. Motion artifact 5-20x larger than cardiac signal. Strong DC fluctuations (¬±10-30%). SpO2 unreliable (artifacts affect Red/IR unequally). IMPORTANT: PPG must contain both underlying cardiac signal AND superimposed motion artifact correlated with ACC.',
    events: []
  },
  '08_running': {
    name: 'Running/Jogging (8-10 km/h)',
    description: 'Running at jogging pace (cadence 2.5-3.5 Hz). ACC: oscillations 1-4g with ground impact peaks reaching 6g. All 3 axes strongly engaged (Y, Z dominant). Slightly more variable than walking. PPG signal nearly unusable for fine measurements. Dominant motion artifacts 10-50x cardiac signal. Frequent sensor lift-off (ADC saturation periods). HR elevated 140-180 bpm (2.3-3 Hz) - dangerously close to running cadence, making separation nearly impossible without ACC. SpO2 completely unreliable. Only viable algorithm: FFT detection with ACC spectral subtraction. Tests algorithm limits.',
    events: []
  },
  '09_wrist_movement': {
    name: 'Wrist Movements (Non-periodic)',
    description: 'Non-periodic hand movements (writing, manipulation, gesticulating). ACC: non-periodic irregular bursts 0.1-2g, episodes 0.5-5s interspersed with pauses. Spectrum: broadband, no dominant peak. Different from walking: no periodicity, no symmetry. PPG: intermittent artifacts during movements but recovers quickly during pauses. Algorithms must identify calm periods (ACC <threshold) to extract vital signs. During pauses, PPG pulse returns to normal shape within 2-5 beats (optical coupling stabilization). HR 70-90 bpm. SpO2 measurable during calm windows.',
    events: []
  },
  '10_af_rapid': {
    name: 'Atrial Fibrillation - Rapid Ventricular Response',
    description: 'Chaotic atrial electrical activity (350-600/min), irregular AV conduction. CARDINAL SIGN: completely irregular RR interval - intervals vary randomly (not respiratory, not periodic). Coefficient of variation RR >15-20%. No respiratory pattern in RR variability (complete chaos replaces sinus arrhythmia). Variable pulse amplitude: PPG amplitude depends on preceding diastolic filling time. Short RR‚Üílow amplitude (insufficient LV filling), long RR‚Üílarge amplitude. Negative RR-amplitude correlation (linear). Ventricular rate 80-160 bpm untreated. Pulse deficit: some premature beats don\'t generate detectable PPG pulse. Dicrotic notch often absent. Unstable baseline with irregular fluctuations. No periodicity in Poincare plot (diffuse cloud).',
    events: []
  },
  '15_psvt_episodes': {
    name: 'Paroxysmal Supraventricular Tachycardia (PSVT)',
    description: 'Nodal re-entry or accessory pathway, abrupt onset and termination. Sudden onset: abrupt transition from normal sinus rhythm (60-80 bpm) to regular rapid tachycardia (150-250 bpm). MAIN CHARACTERISTIC: perfectly regular rhythm - constant RR interval (e.g., 300ms for 200 bpm), near-zero RR variability. Reduced amplitude due to shortened filling time (faster HR‚Üílower amplitude, inverse relationship). Rapid narrow pulses, fast upstroke, descent interrupted by next beat, absent dicrotic notch. Abrupt termination: sudden return to sinus, sometimes preceded by 1-3s pause (sinus node recovery). Episode duration: seconds to hours. Tests transient arrhythmia detection.',
    events: [{time: 900, label: 'PSVT Onset'}, {time: 1800, label: 'Return to Sinus'}]
  },
  '16_vt_monomorphic': {
    name: 'Sustained Monomorphic Ventricular Tachycardia',
    description: 'Ectopic ventricular focus or re-entry circuit, rate 120-250 bpm. Regular/quasi-regular tachycardia at high HR. Very reduced PPG amplitude (30-60%): disorganized ventricular contraction (lack of AV synchronization) produces decreased cardiac output. Deformed morphology: wide pulse, slow upstroke (depolarization doesn\'t follow fast conduction pathways), flattened peak. Atrioventricular dissociation: atria beat independently - may produce "captures" or "fusions" visible as pulses of different amplitude. Hemodynamic instability: amplitude may progressively decrease if poorly tolerated. Risk of transition to VF. Constant morphology, reduced but stable amplitude.',
    events: []
  },
  '17_torsades': {
    name: 'Torsades de Pointes (Polymorphic VT)',
    description: 'Polymorphic VT with progressive QRS axis rotation, often on long QT. Rate 200-300 bpm. CHARACTERISTIC "SPINDLE-SHAPED" PATTERN: PPG pulse amplitude progressively increases then decreases sinusoidally (spindle envelope), periodicity 5-20 beats. Rapid and irregular rhythm with variable RR interval. Amplitude may become transiently undetectable at spindle nadir (contraction too disorganized for palpable pulse). Unstable: may degenerate into VF or terminate spontaneously. Life-threatening arrhythmia requiring immediate intervention.',
    events: []
  },
  '21_vf_from_sinus': {
    name: 'Ventricular Fibrillation from Sinus Rhythm',
    description: 'CARDIAC ARREST - Most frequent (70-80% out-of-hospital arrests). Completely disorganized ventricular electrical activity, no effective mechanical contraction, cardiac output = ZERO. COMPLETE ABSENCE OF PULSATILE COMPONENT: PPG entirely loses AC component, only DC remains. Flat/near-flat signal with only background noise. Primary VF: abrupt transition from organized rhythm to absence of pulse in <5s. Residual amplitude <1% of normal AC, irregular, non-periodic. Coarse VF (early) may show very faint irregular oscillations (<5% normal amplitude) without cardiac periodicity. Fine VF (after several minutes) completely flat. Critical: absence of detectable PPG pulse >40 consecutive seconds must trigger cardiac arrest alarm. ACC: brief convulsions (cerebral anoxia, 5-15s) >2g, 5-8Hz, then complete immobility ~1g static.',
    events: [{time: 1800, label: 'VF Onset - Cardiac Arrest'}]
  },
  '22_vt_to_vf': {
    name: 'Ventricular Tachycardia Degenerating to VF',
    description: 'CARDIAC ARREST PROGRESSION. VT deteriorating to VF: progressive loss of organized rhythm and perfusion over 5-15 seconds. Progressive decrease in PPG pulse amplitude with increasing morphological disorganization, then complete disappearance. Critical situation requiring immediate intervention. Tests cardiac arrest detection algorithm transition handling. Amplitude decreases progressively, becomes increasingly irregular, then flatlines. Final state identical to VF: flat signal, no pulsatile component, only residual noise.',
    events: [{time: 1200, label: 'VT Onset'}, {time: 2400, label: 'VF - Cardiac Arrest'}]
  },
  '23_asystole': {
    name: 'Asystole (Complete Cardiac Standstill)',
    description: 'CARDIAC ARREST - Worst prognosis. Complete absence of cardiac electrical and mechanical activity. Completely flat PPG signal: no AC component. Slowly decreasing DC over minutes (gravitational redistribution of venous blood reduces tissue blood volume at wrist). No cardiac pulsation artifact. DISTINCTION FROM VF: VF may show very faint irregular oscillations (vibrations of fibrillating myocardium), asystole is perfectly flat. ACC: complete immobility (identical to VF after convulsive phase). If CPR: compressions at 100-120/min (1.7-2 Hz) transmitted to wrist (0.2-0.8g, rhythmic, mainly Z-axis). Requires immediate CPR.',
    events: [{time: 1200, label: 'Cardiac Arrest - Asystole'}]
  },
  '24_pea': {
    name: 'Pulseless Electrical Activity (Electromechanical Dissociation)',
    description: 'CARDIAC ARREST. Organized electrical activity on ECG but no effective mechanical contraction. Causes: massive tamponade, tension pneumothorax, massive PE, severe hypovolemia, cardiac rupture. Flat PPG signal (similar to asystole) despite presence of cardiac electrical activity. Possibly: very faint residual irregular oscillations (ineffective mechanical contractions). NOT DISTINGUISHABLE FROM ASYSTOLE BY PPG ALONE (would require ECG). Clinical emergency requiring immediate treatment of underlying cause.',
    events: [{time: 1500, label: 'Loss of Pulse - PEA'}]
  },
  '32_hemorrhagic_shock': {
    name: 'Hypovolemic/Hemorrhagic Shock',
    description: 'Severe blood loss (>20% volume). Progressively reduced PPG amplitude proportional to volume loss. Tachycardia 100-140 bpm. Intense vasoconstriction: DC may decrease significantly. Thready pulse: very low AC amplitude, rapid but small upstroke. Accentuated respiratory variations of PPG amplitude (similar to pulsus paradoxus, >15-20%): reflects increased sensitivity of cardiac filling to intrathoracic pressure in hypovolemia. SpO2 often preserved initially (remaining blood is well oxygenated), then late decline. Progressive hemodynamic deterioration. Compensatory mechanisms failing.',
    events: []
  },
  '33_hypothermia_32C': {
    name: 'Moderate Hypothermia (Core 32¬∞C)',
    description: 'Core temperature 32¬∞C. Bradycardia 50-60 bpm proportional to temperature. Intense peripheral vasoconstriction: very reduced PPG amplitude, poor signal quality. Osborn J wave: positive deflection after systolic peak (equivalent of ECG J wave), visible in hypothermia <32¬∞C (subtle in PPG, 5-10% of pulse). SHIVERING: ACC shows high-frequency tremor (8-13 Hz) and amplitude 0.1-0.5g that heavily contaminates PPG. Prolonged intervals. Increased risk of arrhythmias (PVCs, AF, VT). Tests algorithm robustness to tremor artifacts.',
    events: []
  },
  '34_hypothermia_28C': {
    name: 'Severe Hypothermia (Core 28¬∞C)',
    description: 'Core temperature 28¬∞C. SEVERE CONDITION. Severe bradycardia HR 30-50 bpm. MAJOR VF RISK. Barely detectable perfusion: intense peripheral vasoconstriction makes PPG amplitude nearly undetectable. At <30¬∞C: shivering disappears (metabolic reserve exhaustion), ACC becomes calm but PPG amplitude nearly absent. J-waves more pronounced. High risk of arrhythmias: PVCs, AF, VT, VF increasingly likely with decreasing temperature. Tests algorithm limits with minimal perfusion.',
    events: []
  },
  '35_sleep_apnea': {
    name: 'Obstructive Sleep Apnea (OSA)',
    description: 'Repetitive cycles 30-90s: Normal breathing‚Üíapnea (10-60s)‚Üíabrupt ventilatory resumption. During apnea: SpO2 progressively decreases (10-30s delay after onset), typical desaturation 3-15% depending on severity. Initial HR: reflex bradycardia (diving vagal reflex). At ventilatory resumption: arousal startle (micro-arousal) - ACC shows abrupt movement (0.5-2g), abrupt reflex tachycardia (+20-40 bpm within seconds), SpO2 recovers within 15-30s, PPG amplitude briefly increases (sympathetic activation). Nocturnal pattern: cycles repeat 5 to >60 times/hour (apnea-hypopnea index, AHI). RMSSD: cyclic oscillations synchronous with apneas.',
    events: []
  },
  '40_co_poisoning': {
    name: 'Carbon Monoxide Poisoning',
    description: 'CO poisoning. SpO2 reads falsely high (carboxyhemoglobin), HR may be normal or elevated. Dangerous false readings.',
    events: []
  }
};

// Populate dropdown
const scenarioSelect = document.getElementById('scenarioSelect');
Object.keys(scenarios).sort().forEach(key => {
  const option = document.createElement('option');
  option.value = key;
  option.textContent = `${scenarios[key].name} (${key})`;
  scenarioSelect.appendChild(option);
});

let currentData = null;

async function loadScenario() {
  const scenario = scenarioSelect.value;
  if (!scenario) {
    alert('Please select a scenario');
    return;
  }

  // Show loading
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error').style.display = 'none';
  document.getElementById('graphs').style.display = 'none';
  document.getElementById('description').style.display = 'none';
  document.getElementById('stats').style.display = 'none';

  try {
    // Load JSON data (for GitHub Pages compatibility)
    const jsonPath = `data/${scenario}.json`;
    const response = await fetch(jsonPath);
    if (!response.ok) throw new Error(`Failed to load ${jsonPath}`);
    const data = await response.json();

    currentData = {
      ppgGreen: data.ppg_green || [],
      ppgRed: data.ppg_red || [],
      ppgIR: data.ppg_ir || [],
      acc: data.acc || [],
      activityRecords: data.activity_records || [],
      scenario: scenarios[scenario]
    };

    // Show description
    document.getElementById('descTitle').textContent = currentData.scenario.name;
    document.getElementById('descText').textContent = currentData.scenario.description;
    document.getElementById('description').style.display = 'block';

    // Calculate stats
    updateStats(currentData.activityRecords);

    // Plot graphs
    plotAllGraphs();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('graphs').style.display = 'block';
    document.getElementById('stats').style.display = 'grid';

  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorText').textContent = error.message;
    console.error(error);
  }
}

function updateStats(activityRecords) {
  const duration = activityRecords.length;
  const hrValues = activityRecords.map(r => parseInt(r.bpm)).filter(v => v > 0);
  const spo2Values = activityRecords.map(r => parseInt(r.spo2)).filter(v => v > 0);

  const avgHR = hrValues.length > 0 ? Math.round(hrValues.reduce((a, b) => a + b) / hrValues.length) : 0;
  const avgSpO2 = spo2Values.length > 0 ? Math.round(spo2Values.reduce((a, b) => a + b) / spo2Values.length) : 0;

  document.getElementById('statDuration').textContent = `${duration} min`;
  document.getElementById('statHR').textContent = avgHR > 0 ? `${avgHR}` : '--';
  document.getElementById('statSpO2').textContent = avgSpO2 > 0 ? `${avgSpO2}%` : '--';
  document.getElementById('statRecords').textContent = duration;
}

function plotAllGraphs() {
  plotPPG(currentData.ppgGreen, currentData.ppgRed, currentData.ppgIR);
  plotACC(currentData.acc);
  plotBPM(currentData.activityRecords);
  plotSpO2(currentData.activityRecords);
  synchronizeGraphs();

  // Generate AI analysis
  const analysisHTML = generateAIAnalysis(
    currentData.activityRecords,
    currentData.ppgGreen,
    currentData.ppgRed,
    currentData.ppgIR,
    currentData.acc,
    currentData.scenario
  );
  document.getElementById('aiAnalysis').innerHTML = analysisHTML;
}

function plotPPG(green, red, ir) {
  // Normalize time to start from 0
  const t0 = green.length > 0 ? parseInt(green[0].timestamp) / 1000 : 0;

  const traces = [
    {
      x: green.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: green.map(r => parseInt(r.value)),
      name: 'Green (530nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#00cc00', width: 1}
    },
    {
      x: red.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: red.map(r => parseInt(r.value)),
      name: 'Red (660nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff0000', width: 1}
    },
    {
      x: ir.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: ir.map(r => parseInt(r.value)),
      name: 'IR (940nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#cc00cc', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'PPG Value (ADC counts)'},
    height: 400,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('ppgGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotACC(acc) {
  // Normalize time to start from 0
  const t0 = acc.length > 0 ? parseInt(acc[0].timestamp) / 1000 : 0;

  const traces = [
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accX)),
      name: 'ACC X',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff6b6b', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accY)),
      name: 'ACC Y',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#4ecdc4', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: acc.map(r => parseInt(r.accZ)),
      name: 'ACC Z',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#45b7d1', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'Acceleration (counts)'},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('accGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotBPM(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.bpm_q) === q && parseInt(r.bpm) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.bpm)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [0, 200],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'Heart Rate (bpm)', range: [0, 200]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('bpmGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotSpO2(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.spo2_q) === q && parseInt(r.spo2) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.spo2)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [75, 105],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'SpO2 (%)', range: [75, 105]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('spo2Graph', traces, layout, {responsive: true, displayModeBar: false});
}

function generateAIAnalysis(activityRecords, ppgGreen, ppgRed, ppgIR, acc, scenario) {
  const hrValues = activityRecords.map(r => parseInt(r.bpm)).filter(v => v > 0);
  const spo2Values = activityRecords.map(r => parseInt(r.spo2)).filter(v => v > 0);
  const hrQuality = activityRecords.map(r => parseInt(r.bpm_q));
  const spo2Quality = activityRecords.map(r => parseInt(r.spo2_q));

  const avgHR = hrValues.length > 0 ? Math.round(hrValues.reduce((a, b) => a + b) / hrValues.length) : 0;
  const minHR = hrValues.length > 0 ? Math.min(...hrValues) : 0;
  const maxHR = hrValues.length > 0 ? Math.max(...hrValues) : 0;
  const avgSpO2 = spo2Values.length > 0 ? Math.round(spo2Values.reduce((a, b) => a + b) / spo2Values.length) : 0;
  const minSpO2 = spo2Values.length > 0 ? Math.min(...spo2Values) : 0;
  const maxSpO2 = spo2Values.length > 0 ? Math.max(...spo2Values) : 0;

  const hrQ3_4 = hrQuality.filter(q => q >= 3).length;
  const spo2Q3_4 = spo2Quality.filter(q => q >= 3).length;
  const hrQualityRate = activityRecords.length > 0 ? (hrQ3_4 / activityRecords.length * 100).toFixed(1) : 0;
  const spo2QualityRate = activityRecords.length > 0 ? (spo2Q3_4 / activityRecords.length * 100).toFixed(1) : 0;

  const accX = acc.map(r => parseInt(r.accX));
  const accY = acc.map(r => parseInt(r.accY));
  const accZ = acc.map(r => parseInt(r.accZ));
  const accMag = acc.map((r, i) => Math.sqrt(accX[i]**2 + accY[i]**2 + accZ[i]**2));
  const avgAccMag = accMag.length > 0 ? (accMag.reduce((a, b) => a + b) / accMag.length).toFixed(1) : 0;

  let analysis = `<div style="margin-bottom: 20px;"><strong style="font-size: 16px; color: var(--blue);">üìä Measured Statistics</strong></div>`;

  analysis += `<div style="margin-bottom: 16px;">`;
  analysis += `<strong>Heart Rate:</strong> Avg ${avgHR} bpm (range: ${minHR}-${maxHR} bpm), Quality Q‚â•3: ${hrQualityRate}% of records<br>`;
  analysis += `<strong>SpO2:</strong> Avg ${avgSpO2}% (range: ${minSpO2}-${maxSpO2}%), Quality Q‚â•3: ${spo2QualityRate}% of records<br>`;
  analysis += `<strong>Motion:</strong> ACC magnitude avg ${avgAccMag} counts (1g ‚âà 1024 counts)<br>`;
  analysis += `<strong>Data Volume:</strong> ${activityRecords.length} activity records (1/min), ${ppgGreen.length} PPG samples (~1Hz downsampled)`;
  analysis += `</div>`;

  analysis += `<div style="margin: 24px 0; border-top: 2px solid var(--border); padding-top: 20px;"><strong style="font-size: 16px; color: var(--blue);">üîç Algorithm Performance Analysis</strong></div>`;

  // Scenario-specific analysis
  const scenarioName = scenario.name.toLowerCase();

  if (scenarioName.includes('normal') || scenarioName.includes('rest')) {
    analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> Stable HR 60-80 bpm, SpO2 96-100%, minimal motion (<0.02g)</div>`;
    if (avgHR >= 60 && avgHR <= 80) {
      analysis += `<div style="color: var(--green);">‚úì HR is within expected range for resting state</div>`;
    } else {
      analysis += `<div style="color: var(--orange);">‚ö† HR ${avgHR} bpm is outside expected 60-80 bpm range. Possible causes: (1) synthetic signal generation parameters, (2) individual variation, (3) algorithm tuning needed</div>`;
    }
    if (avgSpO2 >= 96) {
      analysis += `<div style="color: var(--green);">‚úì SpO2 is within expected range for healthy subject</div>`;
    } else if (avgSpO2 === 0) {
      analysis += `<div style="color: var(--red);">‚úó SpO2 = 0 indicates algorithm failure. Possible causes: (1) movement detection too strict, (2) R ratio out of calibration range, (3) signal quality rejection threshold too high</div>`;
    }
  }

  if (scenarioName.includes('hypoxia')) {
    if (scenarioName.includes('mild')) {
      analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> SpO2 90-95%, compensatory tachycardia 80-100 bpm</div>`;
      if (avgSpO2 >= 90 && avgSpO2 <= 95) {
        analysis += `<div style="color: var(--green);">‚úì SpO2 correctly reflects mild hypoxia state</div>`;
      }
    } else if (scenarioName.includes('moderate')) {
      analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> SpO2 80-90%, tachycardia 100-130 bpm, possible AC amplitude reduction</div>`;
    } else if (scenarioName.includes('severe')) {
      analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> SpO2 <80%, severe tachycardia 130-160+ bpm, very low AC amplitude</div>`;
    }
    if (avgSpO2 === 0) {
      analysis += `<div style="color: var(--red);">‚úó SpO2 = 0 in hypoxia scenario indicates algorithm failure. The R ratio polynomial may not be calibrated for extreme values (R > 1.5)</div>`;
    }
  }

  if (scenarioName.includes('walking') || scenarioName.includes('running') || scenarioName.includes('movement')) {
    analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> Large motion artifacts, degraded signal quality, SpO2 unreliable during motion</div>`;
    if (avgAccMag > 1200) {
      analysis += `<div style="color: var(--green);">‚úì ACC shows significant motion (${avgAccMag} counts > 1g baseline)</div>`;
    }
    if (spo2QualityRate < 30) {
      analysis += `<div style="color: var(--green);">‚úì Low SpO2 quality (${spo2QualityRate}%) is expected during motion - algorithm correctly rejects contaminated data</div>`;
    }
    if (hrQualityRate > 50) {
      analysis += `<div style="color: var(--green);">‚úì HR algorithm shows good motion tolerance (${hrQualityRate}% good quality) - likely using ACC for motion artifact rejection</div>`;
    }
  }

  if (scenarioName.includes('cardiac arrest') || scenarioName.includes('vf') || scenarioName.includes('asystole')) {
    analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> Complete loss of pulsatile signal, HR = 0, flat PPG</div>`;
    if (avgHR === 0 || hrValues.length === 0) {
      analysis += `<div style="color: var(--green);">‚úì Algorithm correctly detects absence of pulse (cardiac arrest)</div>`;
    } else {
      analysis += `<div style="color: var(--red);">‚úó HR = ${avgHR} bpm detected during cardiac arrest - false detection. Algorithm may be picking up noise artifacts as pulses. Requires stricter detection thresholds.</div>`;
    }
  }

  if (scenarioName.includes('af') || scenarioName.includes('fibrillation')) {
    analysis += `<div style="margin-bottom: 12px;"><strong>‚úì Expected:</strong> Completely irregular RR intervals, variable pulse amplitude, chaotic rhythm</div>`;
    const rrStd = hrValues.length > 2 ? Math.sqrt(hrValues.map(h => (h - avgHR)**2).reduce((a,b) => a+b) / hrValues.length).toFixed(1) : 0;
    analysis += `<div style="color: var(--blue);">‚Ñπ HR variability (std dev): ${rrStd} bpm. High variability expected in AF (>15 bpm typical)</div>`;
  }

  analysis += `<div style="margin: 24px 0; border-top: 2px solid var(--border); padding-top: 20px;"><strong style="font-size: 16px; color: var(--blue);">üí° Common Discrepancy Causes</strong></div>`;

  analysis += `<div style="line-height: 1.9;">`;
  analysis += `<strong>Why SpO2 might be 0:</strong><br>`;
  analysis += `‚Ä¢ <strong>Movement rejection:</strong> idle_detection state > ALMOST_IDLE (1) causes SpO2 rejection. Solution: feed real ACC data to mmt_idle_detection_feed_acc()<br>`;
  analysis += `‚Ä¢ <strong>R ratio out of range:</strong> Polynomial SpO2 = 108.49 - 30.09√óR - 0.03√óR¬≤ only valid for R ‚àà [0.4, 3.4]. Extreme values rejected<br>`;
  analysis += `‚Ä¢ <strong>Signal quality:</strong> PPG amplitude too low (low perfusion), AC/DC ratio <0.4%, or quality flags indicate unreliable signal<br>`;
  analysis += `‚Ä¢ <strong>Reporting rate:</strong> Default 30-min intervals means no output during 1-hour test. Use mmt_process_fxi_set_reporting_rate_spo2(60) for 1-min rate<br><br>`;

  analysis += `<strong>Why HR quality varies:</strong><br>`;
  analysis += `‚Ä¢ <strong>Motion artifacts:</strong> Walking/running cadence (1.8-3.5 Hz) overlaps HR band (1-2.7 Hz = 60-160 bpm), requires ACC-based separation<br>`;
  analysis += `‚Ä¢ <strong>Low amplitude:</strong> Vasoconstriction in shock/hypothermia reduces AC component, increases noise sensitivity<br>`;
  analysis += `‚Ä¢ <strong>Arrhythmias:</strong> Irregular rhythms (AF, PVCs) may confuse peak detection, reduce quality scores<br><br>`;

  analysis += `<strong>Data quality indicators:</strong><br>`;
  analysis += `‚Ä¢ <strong>Q=0 (gray):</strong> No quality / not measured<br>`;
  analysis += `‚Ä¢ <strong>Q=1-2 (red/yellow):</strong> Low/medium quality - unreliable for clinical use, but algorithm attempting measurement<br>`;
  analysis += `‚Ä¢ <strong>Q=3-4 (green/cyan):</strong> Good/excellent quality - clinically reliable measurements<br>`;
  analysis += `</div>`;

  analysis += `<div style="margin: 24px 0; border-top: 2px solid var(--border); padding-top: 20px;"><strong style="font-size: 16px; color: var(--blue);">üéØ Firmware Algorithm Status</strong></div>`;

  analysis += `<div style="background: var(--green-bg); border-left: 4px solid var(--green); padding: 16px; margin-bottom: 12px; border-radius: 6px;">`;
  analysis += `<strong style="color: var(--green);">‚úì Working Algorithms:</strong><br>`;
  analysis += `‚Ä¢ Heart Rate (mmt_hrm_process): ${hrQualityRate}% good quality<br>`;
  analysis += `‚Ä¢ Movement Detection (mmt_idle_detection): Real implementation with ACC feed<br>`;
  analysis += `‚Ä¢ Activity Records: Generating 1-minute reports correctly`;
  analysis += `</div>`;

  if (avgSpO2 > 0) {
    analysis += `<div style="background: var(--green-bg); border-left: 4px solid var(--green); padding: 16px; margin-bottom: 12px; border-radius: 6px;">`;
    analysis += `<strong style="color: var(--green);">‚úì SpO2 Algorithm:</strong> Producing measurements (avg ${avgSpO2}%), ${spo2QualityRate}% good quality`;
    analysis += `</div>`;
  } else {
    analysis += `<div style="background: var(--orange-bg); border-left: 4px solid var(--orange); padding: 16px; margin-bottom: 12px; border-radius: 6px;">`;
    analysis += `<strong style="color: var(--orange);">‚ö† SpO2 Algorithm:</strong> Not producing measurements (all zeros). Check: (1) movement detection state, (2) R ratio range, (3) reporting rate configuration`;
    analysis += `</div>`;
  }

  analysis += `<div style="background: var(--blue-bg); border-left: 4px solid var(--blue); padding: 16px; border-radius: 6px;">`;
  analysis += `<strong style="color: var(--blue);">‚Ñπ Simulation Architecture:</strong><br>`;
  analysis += `‚Ä¢ Simulator reads synthetic CSV data (PPG + ACC at 32 Hz)<br>`;
  analysis += `‚Ä¢ Feeds data to REAL firmware algorithms (not stubs)<br>`;
  analysis += `‚Ä¢ Minimal stubs only for hardware HAL (nRF52840, sensors)<br>`;
  analysis += `‚Ä¢ Output: activity_records.csv with 1-minute vital signs<br>`;
  analysis += `‚Ä¢ This viewer: downsampled to 1 Hz for web display (GitHub Pages compatible)`;
  analysis += `</div>`;

  return analysis;
}

function synchronizeGraphs() {
  const graphIds = ['ppgGraph', 'accGraph', 'bpmGraph', 'spo2Graph'];

  graphIds.forEach(id => {
    const graph = document.getElementById(id);

    graph.on('plotly_relayout', (eventdata) => {
      if (eventdata['xaxis.range[0]'] !== undefined && eventdata['xaxis.range[1]'] !== undefined) {
        const xrange = [eventdata['xaxis.range[0]'], eventdata['xaxis.range[1]']];
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.range': xrange});
          }
        });
      } else if (eventdata['xaxis.autorange'] === true) {
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.autorange': true});
          }
        });
      }
    });
  });
}
</script>
</body>
</html>
