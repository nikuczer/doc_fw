<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CardioWatch 287-2B ‚Äî Golden Data Viewer</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
:root {
  --bg: #f5f7fa;
  --card: #ffffff;
  --accent: #1a73e8;
  --accent-light: #e8f0fe;
  --text: #202124;
  --text2: #5f6368;
  --border: #dadce0;
  --green: #0d652d;
  --green-bg: #e6f4ea;
  --orange: #e37400;
  --orange-bg: #fef7e0;
  --red: #c5221f;
  --red-bg: #fce8e6;
  --blue: #1967d2;
  --blue-bg: #e8f0fe;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
header { background: linear-gradient(135deg, #1a237e 0%, #1565c0 100%); color: #fff; padding: 32px 40px; }
header h1 { font-size: 28px; font-weight: 600; }
header p { color: #bbdefb; margin-top: 6px; font-size: 15px; }

.controls { background: var(--card); border-bottom: 2px solid var(--border); padding: 20px 40px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,.06); }
.control-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.control-row label { font-size: 14px; font-weight: 500; color: var(--text2); min-width: 100px; }
.control-row select { flex: 1; max-width: 500px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px; background: white; cursor: pointer; transition: border-color .15s; }
.control-row select:hover { border-color: var(--accent); }
.control-row select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
.btn { padding: 10px 24px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .15s; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: #1557b0; box-shadow: 0 2px 8px rgba(26,115,232,.3); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }

.content { padding: 32px 40px; margin: 0 auto; }

.description-card { background: var(--orange-bg); border: 1px solid var(--orange); border-left: 4px solid var(--orange); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.description-card h2 { font-size: 18px; color: var(--orange); margin-bottom: 8px; font-weight: 600; }
.description-card p { color: var(--text); font-size: 14px; line-height: 1.6; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
.stat-card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
.stat-card .value { font-size: 32px; font-weight: 700; color: var(--accent); }

.graph-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.graph-card .header { background: var(--accent-light); color: var(--accent); padding: 14px 20px; font-weight: 600; font-size: 16px; border-bottom: 2px solid var(--border); }
.graph-card .body { padding: 0; width: 100%; }

.loading { text-align: center; padding: 60px 20px; }
.loading .spinner { width: 48px; height: 48px; border: 4px solid var(--accent-light); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading p { font-size: 16px; color: var(--text2); }

.error-card { background: var(--red-bg); border: 1px solid var(--red); border-left: 4px solid var(--red); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; }
.error-card h3 { color: var(--red); font-size: 16px; margin-bottom: 8px; }
.error-card p { color: var(--text); font-size: 14px; }

.quality-legend { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 20px; background: var(--bg); border-radius: 8px; margin-bottom: 16px; }
.quality-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text2); }
.quality-dot { width: 12px; height: 12px; border-radius: 50%; }

footer { text-align: center; padding: 32px 20px; color: var(--text2); font-size: 13px; border-top: 1px solid var(--border); margin-top: 40px; }

@media(max-width:768px) {
  .content { padding: 20px; }
  header { padding: 20px; }
  .controls { padding: 16px 20px; }
  .control-row { flex-direction: column; align-items: stretch; }
  .control-row label { min-width: unset; }
  .control-row select { max-width: 100%; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>CardioWatch 287-2B &mdash; Golden Data Viewer</h1>
  <p>Interactive Signal Analysis &bull; 40 Clinical Scenarios &bull; Simulator Test Suite</p>
</header>

<div id="pipelineSection" style="background: white; border-bottom: 1px solid var(--border); padding: 32px 40px;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h2 style="font-size: 20px; font-weight: 600; color: var(--text); margin-bottom: 16px;">üî¨ Firmware Validation Pipeline</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 20px;">

      <div style="background: var(--blue-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--blue);">
        <div style="font-weight: 600; color: var(--blue); margin-bottom: 8px; font-size: 15px;">üìä 1. Golden Data Generation</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Python script (<code>generate.py</code>) generates 40 clinical scenarios with synthetic PPG (Green/Red/IR) and ACC signals at 32 Hz. Each scenario simulates specific physiological conditions (rest, hypoxia, arrhythmias, cardiac arrest, etc.) based on clinical signal guide specifications.
        </div>
      </div>

      <div style="background: var(--green-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--green);">
        <div style="font-weight: 600; color: var(--green); margin-bottom: 8px; font-size: 15px;">‚öôÔ∏è 2. C Simulator Execution</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          C simulator (<code>sim_api.c</code>) reads CSV data and feeds it to REAL firmware algorithms. Uses minimal stubs only for hardware HAL (nRF52840, MAX86178, LIS2DW12). Algorithms like SpO2, HR detection, movement detection run with actual production code.
        </div>
      </div>

      <div style="background: var(--orange-bg); padding: 20px; border-radius: 10px; border-left: 4px solid var(--orange);">
        <div style="font-weight: 600; color: var(--orange); margin-bottom: 8px; font-size: 15px;">üîß 3. Stub Architecture</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Philosophy: Keep REAL implementations, stub ONLY what's necessary. Real algorithms: <code>mmt_spo2.c</code>, <code>mmt_hrm_process.c</code>, <code>mmt_idle_detection.c</code>. Stubbed: hardware drivers, BLE, flash storage. This validates actual firmware behavior, not fake logic.
        </div>
      </div>

      <div style="background: var(--accent-light); padding: 20px; border-radius: 10px; border-left: 4px solid var(--accent);">
        <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px; font-size: 15px;">üìà 4. Output & Visualization</div>
        <div style="font-size: 13px; line-height: 1.6; color: var(--text);">
          Simulator outputs <code>activity_records.csv</code> (1-minute vital signs: HR, SpO2, quality scores). Python script downsamples data (32Hz‚Üí1Hz) and converts to JSON for GitHub Pages. This viewer provides interactive analysis with synchronized graphs and AI insights.
        </div>
      </div>

    </div>

    <div style="margin-top: 20px; padding: 16px 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%); border-radius: 8px; border: 1px solid var(--border);">
      <div style="font-size: 13px; line-height: 1.7; color: var(--text2);">
        <strong style="color: var(--text);">Key Design Principle:</strong> The simulator runs production firmware algorithms against synthetic clinical data to validate correctness across 40 physiological scenarios. This approach catches algorithm bugs early (SpO2 calibration, movement rejection, arrhythmia detection) before hardware testing. Results are version-controlled and web-accessible for continuous validation.
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <div class="control-row">
    <label for="scenarioSelect">Clinical Scenario:</label>
    <select id="scenarioSelect">
      <option value="">-- Select a clinical test scenario --</option>
    </select>
    <button class="btn btn-primary" id="loadBtn" onclick="loadScenario()">Load Data</button>
  </div>
  <div id="viewControls" class="control-row" style="display:none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
    <label style="min-width: auto; margin-right: 20px;">
      <input type="checkbox" id="removeDC" onchange="updateGraphs()" style="margin-right: 6px;">
      Remove DC offset (ACC)
    </label>
    <label style="flex: 1; display: flex; align-items: center; gap: 10px;">
      <span style="min-width: 80px;">Time range:</span>
      <input type="range" id="timeStart" min="0" max="3600" value="0" step="1" style="flex: 1;" oninput="updateTimeRange()">
      <span id="timeStartLabel" style="min-width: 50px;">0s</span>
      <span>to</span>
      <input type="range" id="timeEnd" min="0" max="3600" value="3600" step="1" style="flex: 1;" oninput="updateTimeRange()">
      <span id="timeEndLabel" style="min-width: 50px;">3600s</span>
    </label>
  </div>
</div>

<div class="content">
  <div id="description" style="display:none;">
    <div class="description-card">
      <h2 id="descTitle"></h2>
      <p id="descText"></p>
    </div>
  </div>

  <div id="stats" class="stats-grid" style="display:none;">
    <div class="stat-card">
      <div class="label">Duration</div>
      <div class="value" id="statDuration">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg HR</div>
      <div class="value" id="statHR">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Avg SpO2</div>
      <div class="value" id="statSpO2">--</div>
    </div>
    <div class="stat-card">
      <div class="label">Records</div>
      <div class="value" id="statRecords">--</div>
    </div>
  </div>

  <div id="loading" style="display:none;">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading clinical data...</p>
    </div>
  </div>

  <div id="error" style="display:none;">
    <div class="error-card">
      <h3>Error Loading Data</h3>
      <p id="errorText"></p>
    </div>
  </div>

  <div id="graphs" style="display:none;">
    <div class="quality-legend">
      <div class="quality-item"><div class="quality-dot" style="background:#cccccc"></div>Q=0 No Quality</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ff6b6b"></div>Q=1 Low</div>
      <div class="quality-item"><div class="quality-dot" style="background:#ffd93d"></div>Q=2 Medium</div>
      <div class="quality-item"><div class="quality-dot" style="background:#6bcf7f"></div>Q=3 Good</div>
      <div class="quality-item"><div class="quality-dot" style="background:#4ecdc4"></div>Q=4 Excellent</div>
    </div>

    <div class="graph-card">
      <div class="header">PPG Signals &mdash; Multi-wavelength (Green 530nm, Red 660nm, IR 940nm)</div>
      <div class="body"><div id="ppgGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Accelerometer &mdash; 3-Axis Motion (X, Y, Z)</div>
      <div class="body"><div id="accGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">Heart Rate (BPM) &mdash; Color-coded by Quality Score</div>
      <div class="body"><div id="bpmGraph"></div></div>
    </div>

    <div class="graph-card">
      <div class="header">SpO2 (%) &mdash; Blood Oxygen Saturation by Quality Score</div>
      <div class="body"><div id="spo2Graph"></div></div>
    </div>

    <div class="graph-card" style="margin-top: 32px;">
      <div class="header" style="background: linear-gradient(135deg, #1a237e 0%, #1565c0 100%); color: white;">ü§ñ AI Analysis of Output Data + Logs</div>
      <div class="body" style="padding: 24px;">
        <div id="aiAnalysis" style="line-height: 1.8; font-size: 14px; color: var(--text);"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>CardioWatch 287-2B by Corsano Health &bull; Firmware Simulator &bull; Golden Test Data Suite</p>
</footer>

<script>
// Scenario descriptions from clinical signal guide
const scenarios = {
  '01_normal_rest': {
    name: 'Normal Rest - Healthy Subject',
    description: 'Reference hemodynamic profile: HR 60-80 bpm (RR interval 750-1000 ms), SpO2 96-100%, BP 110-130/70-85 mmHg. Expected morphology: regular well-defined pulse, AC/DC ratio 1-3%, fast upstroke (100-150 ms), sharp systolic peak, visible dicrotic notch. Respiratory sinus arrhythmia present (3-8 bpm modulation). Stable R ratio 0.5-0.7. ACC quasi-static ~1g, micro-variations <0.02g.',
    events: []
  },
  '02_elderly_rest': {
    name: 'Rest - Elderly Subject (70 yrs)',
    description: 'Elderly patient at rest with age-related cardiovascular changes. HR typically 70-85 bpm. May show attenuated dicrotic notch due to arterial stiffening. More prominent diastolic wave (arterial stiffness). Inter-pulse amplitude variability may be slightly higher. Respiratory modulation may be reduced. SpO2 typically 95-98%. Some isolated premature beats may occur (<1% of beats).',
    events: []
  },
  '03_athlete_rest': {
    name: 'Rest - Athletic Subject',
    description: 'Athletic individual at rest showing training bradycardia. HR 40-55 bpm with prolonged RR interval >1000 ms. Increased PPG amplitude (prolonged diastolic filling allows greater stroke volume). Well-visible dicrotic notch due to good arterial compliance. High HRV (SDNN 50-100+ ms). Strong cardiac output. Extended diastolic phase. SpO2 99-100%. Signal descends almost to baseline before next upstroke.',
    events: []
  },
  '04_hypoxia_mild': {
    name: 'Mild Hypoxia (SpO2 90-95%)',
    description: 'Clinical context: early respiratory failure, moderate altitude (2500-3500m), stable COPD, early pneumonia. R ratio increases to 0.8-1.0 (AC Red amplitude increases as deoxyhemoglobin concentration rises). Mild compensatory tachycardia 80-100 bpm due to sympathetic activation. AC Green amplitude may be normal or slightly decreased. Respiratory rate increased to 18-25 cycles/min (compensatory tachypnea), visible in PPG envelope modulation. Pulse morphology may remain normal.',
    events: []
  },
  '05_hypoxia_moderate': {
    name: 'Moderate Hypoxia (SpO2 80-90%)',
    description: 'Clinical context: acute respiratory failure, pulmonary embolism, severe asthma attack, pneumothorax, high altitude (>4000m) without acclimatization. R ratio 1.0-1.4. Tachycardia 100-130 bpm, RR interval shortened to 460-600 ms. Decreased HRV (RMSSD <15 ms) due to sympathetic predominance. AC amplitude may decrease due to compensatory peripheral vasoconstriction (output redistribution to vital organs). DC decreases as total peripheral blood volume reduces. Signal quality may degrade. Respiratory rate 25-35 cycles/min with more pronounced PPG modulation. Possible fine tremors (0.02-0.05g) in ACC if patient in distress.',
    events: []
  },
  '06_hypoxia_severe': {
    name: 'Severe Hypoxia (SpO2 <80%)',
    description: 'Clinical context: acute respiratory distress, ARDS, partial drowning, airway obstruction. CRITICAL CONDITION. R ratio >1.5 (can reach 2.0). Severe tachycardia 130-160+ bpm, then terminal bradycardia if hypoxia persists (myocardial failure, loss of sympathetic tone - extreme severity sign). Very low AC amplitude (intense vasoconstriction, can drop 60-80% vs normal). Deformed pulse wave: disappearance of dicrotic notch due to hypotension and vasoconstriction. Increased inter-pulse variability (hemodynamic instability). Possible pulsus alternans (regular alternation strong/weak pulses = severe LV failure). ACC: possible agitation (0.1-0.5g) initially, progressive immobility if LOC, possible hypoxic seizures (5-8 Hz, >1g bursts, 10-60s).',
    events: []
  },
  '07_walking': {
    name: 'Normal Walking (4-5 km/h)',
    description: 'Walking at comfortable speed (cadence 1.8-2.2 Hz). ACC: regular oscillations 0.3-1.5g around 1g. Y-axis (forearm) shows dominant walking cadence ~2Hz. Z-axis shows heel strike impacts. Spectrum: fundamental peak at step frequency with harmonics. PPG severely contaminated by motion artifacts: (a) sensor lift-off, (b) contact pressure variation, (c) venous blood movement (muscle pump), (d) arteriole deformation by tendons. Motion artifact 5-20x larger than cardiac signal. Strong DC fluctuations (¬±10-30%). SpO2 unreliable (artifacts affect Red/IR unequally). IMPORTANT: PPG must contain both underlying cardiac signal AND superimposed motion artifact correlated with ACC.',
    events: []
  },
  '08_running': {
    name: 'Running/Jogging (8-10 km/h)',
    description: 'Running at jogging pace (cadence 2.5-3.5 Hz). ACC: oscillations 1-4g with ground impact peaks reaching 6g. All 3 axes strongly engaged (Y, Z dominant). Slightly more variable than walking. PPG signal nearly unusable for fine measurements. Dominant motion artifacts 10-50x cardiac signal. Frequent sensor lift-off (ADC saturation periods). HR elevated 140-180 bpm (2.3-3 Hz) - dangerously close to running cadence, making separation nearly impossible without ACC. SpO2 completely unreliable. Only viable algorithm: FFT detection with ACC spectral subtraction. Tests algorithm limits.',
    events: []
  },
  '09_wrist_movement': {
    name: 'Wrist Movements (Non-periodic)',
    description: 'Non-periodic hand movements (writing, manipulation, gesticulating). ACC: non-periodic irregular bursts 0.1-2g, episodes 0.5-5s interspersed with pauses. Spectrum: broadband, no dominant peak. Different from walking: no periodicity, no symmetry. PPG: intermittent artifacts during movements but recovers quickly during pauses. Algorithms must identify calm periods (ACC <threshold) to extract vital signs. During pauses, PPG pulse returns to normal shape within 2-5 beats (optical coupling stabilization). HR 70-90 bpm. SpO2 measurable during calm windows.',
    events: []
  },
  '10_af_rapid': {
    name: 'Atrial Fibrillation - Rapid Ventricular Response',
    description: 'Chaotic atrial electrical activity (350-600/min), irregular AV conduction. CARDINAL SIGN: completely irregular RR interval - intervals vary randomly (not respiratory, not periodic). Coefficient of variation RR >15-20%. No respiratory pattern in RR variability (complete chaos replaces sinus arrhythmia). Variable pulse amplitude: PPG amplitude depends on preceding diastolic filling time. Short RR‚Üílow amplitude (insufficient LV filling), long RR‚Üílarge amplitude. Negative RR-amplitude correlation (linear). Ventricular rate 80-160 bpm untreated. Pulse deficit: some premature beats don\'t generate detectable PPG pulse. Dicrotic notch often absent. Unstable baseline with irregular fluctuations. No periodicity in Poincare plot (diffuse cloud).',
    events: []
  },
  '15_psvt_episodes': {
    name: 'Paroxysmal Supraventricular Tachycardia (PSVT)',
    description: 'Nodal re-entry or accessory pathway, abrupt onset and termination. Sudden onset: abrupt transition from normal sinus rhythm (60-80 bpm) to regular rapid tachycardia (150-250 bpm). MAIN CHARACTERISTIC: perfectly regular rhythm - constant RR interval (e.g., 300ms for 200 bpm), near-zero RR variability. Reduced amplitude due to shortened filling time (faster HR‚Üílower amplitude, inverse relationship). Rapid narrow pulses, fast upstroke, descent interrupted by next beat, absent dicrotic notch. Abrupt termination: sudden return to sinus, sometimes preceded by 1-3s pause (sinus node recovery). Episode duration: seconds to hours. Tests transient arrhythmia detection.',
    events: [{time: 900, label: 'PSVT Onset'}, {time: 1800, label: 'Return to Sinus'}]
  },
  '16_vt_monomorphic': {
    name: 'Sustained Monomorphic Ventricular Tachycardia',
    description: 'Ectopic ventricular focus or re-entry circuit, rate 120-250 bpm. Regular/quasi-regular tachycardia at high HR. Very reduced PPG amplitude (30-60%): disorganized ventricular contraction (lack of AV synchronization) produces decreased cardiac output. Deformed morphology: wide pulse, slow upstroke (depolarization doesn\'t follow fast conduction pathways), flattened peak. Atrioventricular dissociation: atria beat independently - may produce "captures" or "fusions" visible as pulses of different amplitude. Hemodynamic instability: amplitude may progressively decrease if poorly tolerated. Risk of transition to VF. Constant morphology, reduced but stable amplitude.',
    events: []
  },
  '17_torsades': {
    name: 'Torsades de Pointes (Polymorphic VT)',
    description: 'Polymorphic VT with progressive QRS axis rotation, often on long QT. Rate 200-300 bpm. CHARACTERISTIC "SPINDLE-SHAPED" PATTERN: PPG pulse amplitude progressively increases then decreases sinusoidally (spindle envelope), periodicity 5-20 beats. Rapid and irregular rhythm with variable RR interval. Amplitude may become transiently undetectable at spindle nadir (contraction too disorganized for palpable pulse). Unstable: may degenerate into VF or terminate spontaneously. Life-threatening arrhythmia requiring immediate intervention.',
    events: []
  },
  '21_vf_from_sinus': {
    name: 'Ventricular Fibrillation from Sinus Rhythm',
    description: 'CARDIAC ARREST - Most frequent (70-80% out-of-hospital arrests). Completely disorganized ventricular electrical activity, no effective mechanical contraction, cardiac output = ZERO. COMPLETE ABSENCE OF PULSATILE COMPONENT: PPG entirely loses AC component, only DC remains. Flat/near-flat signal with only background noise. Primary VF: abrupt transition from organized rhythm to absence of pulse in <5s. Residual amplitude <1% of normal AC, irregular, non-periodic. Coarse VF (early) may show very faint irregular oscillations (<5% normal amplitude) without cardiac periodicity. Fine VF (after several minutes) completely flat. Critical: absence of detectable PPG pulse >40 consecutive seconds must trigger cardiac arrest alarm. ACC: brief convulsions (cerebral anoxia, 5-15s) >2g, 5-8Hz, then complete immobility ~1g static.',
    events: [{time: 1800, label: 'VF Onset - Cardiac Arrest'}]
  },
  '22_vt_to_vf': {
    name: 'Ventricular Tachycardia Degenerating to VF',
    description: 'CARDIAC ARREST PROGRESSION. VT deteriorating to VF: progressive loss of organized rhythm and perfusion over 5-15 seconds. Progressive decrease in PPG pulse amplitude with increasing morphological disorganization, then complete disappearance. Critical situation requiring immediate intervention. Tests cardiac arrest detection algorithm transition handling. Amplitude decreases progressively, becomes increasingly irregular, then flatlines. Final state identical to VF: flat signal, no pulsatile component, only residual noise.',
    events: [{time: 1200, label: 'VT Onset'}, {time: 2400, label: 'VF - Cardiac Arrest'}]
  },
  '23_asystole': {
    name: 'Asystole (Complete Cardiac Standstill)',
    description: 'CARDIAC ARREST - Worst prognosis. Complete absence of cardiac electrical and mechanical activity. Completely flat PPG signal: no AC component. Slowly decreasing DC over minutes (gravitational redistribution of venous blood reduces tissue blood volume at wrist). No cardiac pulsation artifact. DISTINCTION FROM VF: VF may show very faint irregular oscillations (vibrations of fibrillating myocardium), asystole is perfectly flat. ACC: complete immobility (identical to VF after convulsive phase). If CPR: compressions at 100-120/min (1.7-2 Hz) transmitted to wrist (0.2-0.8g, rhythmic, mainly Z-axis). Requires immediate CPR.',
    events: [{time: 1200, label: 'Cardiac Arrest - Asystole'}]
  },
  '24_pea': {
    name: 'Pulseless Electrical Activity (Electromechanical Dissociation)',
    description: 'CARDIAC ARREST. Organized electrical activity on ECG but no effective mechanical contraction. Causes: massive tamponade, tension pneumothorax, massive PE, severe hypovolemia, cardiac rupture. Flat PPG signal (similar to asystole) despite presence of cardiac electrical activity. Possibly: very faint residual irregular oscillations (ineffective mechanical contractions). NOT DISTINGUISHABLE FROM ASYSTOLE BY PPG ALONE (would require ECG). Clinical emergency requiring immediate treatment of underlying cause.',
    events: [{time: 1500, label: 'Loss of Pulse - PEA'}]
  },
  '32_hemorrhagic_shock': {
    name: 'Hypovolemic/Hemorrhagic Shock',
    description: 'Severe blood loss (>20% volume). Progressively reduced PPG amplitude proportional to volume loss. Tachycardia 100-140 bpm. Intense vasoconstriction: DC may decrease significantly. Thready pulse: very low AC amplitude, rapid but small upstroke. Accentuated respiratory variations of PPG amplitude (similar to pulsus paradoxus, >15-20%): reflects increased sensitivity of cardiac filling to intrathoracic pressure in hypovolemia. SpO2 often preserved initially (remaining blood is well oxygenated), then late decline. Progressive hemodynamic deterioration. Compensatory mechanisms failing.',
    events: []
  },
  '33_hypothermia_32C': {
    name: 'Moderate Hypothermia (Core 32¬∞C)',
    description: 'Core temperature 32¬∞C. Bradycardia 50-60 bpm proportional to temperature. Intense peripheral vasoconstriction: very reduced PPG amplitude, poor signal quality. Osborn J wave: positive deflection after systolic peak (equivalent of ECG J wave), visible in hypothermia <32¬∞C (subtle in PPG, 5-10% of pulse). SHIVERING: ACC shows high-frequency tremor (8-13 Hz) and amplitude 0.1-0.5g that heavily contaminates PPG. Prolonged intervals. Increased risk of arrhythmias (PVCs, AF, VT). Tests algorithm robustness to tremor artifacts.',
    events: []
  },
  '34_hypothermia_28C': {
    name: 'Severe Hypothermia (Core 28¬∞C)',
    description: 'Core temperature 28¬∞C. SEVERE CONDITION. Severe bradycardia HR 30-50 bpm. MAJOR VF RISK. Barely detectable perfusion: intense peripheral vasoconstriction makes PPG amplitude nearly undetectable. At <30¬∞C: shivering disappears (metabolic reserve exhaustion), ACC becomes calm but PPG amplitude nearly absent. J-waves more pronounced. High risk of arrhythmias: PVCs, AF, VT, VF increasingly likely with decreasing temperature. Tests algorithm limits with minimal perfusion.',
    events: []
  },
  '35_sleep_apnea': {
    name: 'Obstructive Sleep Apnea (OSA)',
    description: 'Repetitive cycles 30-90s: Normal breathing‚Üíapnea (10-60s)‚Üíabrupt ventilatory resumption. During apnea: SpO2 progressively decreases (10-30s delay after onset), typical desaturation 3-15% depending on severity. Initial HR: reflex bradycardia (diving vagal reflex). At ventilatory resumption: arousal startle (micro-arousal) - ACC shows abrupt movement (0.5-2g), abrupt reflex tachycardia (+20-40 bpm within seconds), SpO2 recovers within 15-30s, PPG amplitude briefly increases (sympathetic activation). Nocturnal pattern: cycles repeat 5 to >60 times/hour (apnea-hypopnea index, AHI). RMSSD: cyclic oscillations synchronous with apneas.',
    events: []
  },
  '40_co_poisoning': {
    name: 'Carbon Monoxide Poisoning',
    description: 'CO poisoning. SpO2 reads falsely high (carboxyhemoglobin), HR may be normal or elevated. Dangerous false readings.',
    events: []
  }
};

// Populate dropdown
const scenarioSelect = document.getElementById('scenarioSelect');
Object.keys(scenarios).sort().forEach(key => {
  const option = document.createElement('option');
  option.value = key;
  option.textContent = `${scenarios[key].name} (${key})`;
  scenarioSelect.appendChild(option);
});

let currentData = null;

async function loadScenario() {
  const scenario = scenarioSelect.value;
  if (!scenario) {
    alert('Please select a scenario');
    return;
  }

  // Show loading, hide pipeline
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error').style.display = 'none';
  document.getElementById('graphs').style.display = 'none';
  document.getElementById('description').style.display = 'none';
  document.getElementById('stats').style.display = 'none';
  document.getElementById('pipelineSection').style.display = 'none';

  try {
    // Load JSON data (for GitHub Pages compatibility)
    const jsonPath = `data/${scenario}.json`;
    const response = await fetch(jsonPath);
    if (!response.ok) throw new Error(`Failed to load ${jsonPath}`);
    const data = await response.json();

    currentData = {
      ppgGreen: data.ppg_green || [],
      ppgRed: data.ppg_red || [],
      ppgIR: data.ppg_ir || [],
      acc: data.acc || [],
      activityRecords: data.activity_records || [],
      scenario: scenarios[scenario]
    };

    // Show description
    document.getElementById('descTitle').textContent = currentData.scenario.name;
    document.getElementById('descText').textContent = currentData.scenario.description;
    document.getElementById('description').style.display = 'block';

    // Calculate stats
    updateStats(currentData.activityRecords);

    // Plot graphs
    plotAllGraphs();

    document.getElementById('loading').style.display = 'none';
    document.getElementById('graphs').style.display = 'block';
    document.getElementById('stats').style.display = 'grid';
    document.getElementById('viewControls').style.display = 'flex';

    // Set time range sliders max value based on data duration
    const maxTime = Math.max(...currentData.activityRecords.map(r => parseInt(r.timestamp)));
    document.getElementById('timeStart').max = maxTime;
    document.getElementById('timeEnd').max = maxTime;
    document.getElementById('timeEnd').value = maxTime;
    document.getElementById('timeEndLabel').textContent = maxTime + 's';

  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('errorText').textContent = error.message;
    console.error(error);
  }
}

function updateGraphs() {
  if (!currentData) return;
  plotAllGraphs();
}

function updateTimeRange() {
  const start = parseInt(document.getElementById('timeStart').value);
  const end = parseInt(document.getElementById('timeEnd').value);

  // Update labels
  document.getElementById('timeStartLabel').textContent = start + 's';
  document.getElementById('timeEndLabel').textContent = end + 's';

  // Ensure start < end
  if (start >= end) {
    document.getElementById('timeEnd').value = start + 10;
    document.getElementById('timeEndLabel').textContent = (start + 10) + 's';
    return;
  }

  // Update all graphs with new time range
  const graphIds = ['ppgGraph', 'accGraph', 'bpmGraph', 'spo2Graph'];
  graphIds.forEach(id => {
    Plotly.relayout(id, {
      'xaxis.range': [start, end]
    });
  });
}

function updateStats(activityRecords) {
  const duration = activityRecords.length;
  const hrValues = activityRecords.map(r => parseInt(r.bpm)).filter(v => v > 0);
  const spo2Values = activityRecords.map(r => parseInt(r.spo2)).filter(v => v > 0);

  const avgHR = hrValues.length > 0 ? Math.round(hrValues.reduce((a, b) => a + b) / hrValues.length) : 0;
  const avgSpO2 = spo2Values.length > 0 ? Math.round(spo2Values.reduce((a, b) => a + b) / spo2Values.length) : 0;

  document.getElementById('statDuration').textContent = `${duration} min`;
  document.getElementById('statHR').textContent = avgHR > 0 ? `${avgHR}` : '--';
  document.getElementById('statSpO2').textContent = avgSpO2 > 0 ? `${avgSpO2}%` : '--';
  document.getElementById('statRecords').textContent = duration;
}

function plotAllGraphs() {
  plotPPG(currentData.ppgGreen, currentData.ppgRed, currentData.ppgIR);
  plotACC(currentData.acc);
  plotBPM(currentData.activityRecords);
  plotSpO2(currentData.activityRecords);
  synchronizeGraphs();

  // Generate AI analysis
  const analysisHTML = generateAIAnalysis(
    currentData.activityRecords,
    currentData.ppgGreen,
    currentData.ppgRed,
    currentData.ppgIR,
    currentData.acc,
    currentData.scenario
  );
  document.getElementById('aiAnalysis').innerHTML = analysisHTML;
}

function plotPPG(green, red, ir) {
  // Normalize time to start from 0
  const t0 = green.length > 0 ? parseInt(green[0].timestamp) / 1000 : 0;

  const traces = [
    {
      x: green.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: green.map(r => parseInt(r.value)),
      name: 'Green (530nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#00cc00', width: 1}
    },
    {
      x: red.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: red.map(r => parseInt(r.value)),
      name: 'Red (660nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff0000', width: 1}
    },
    {
      x: ir.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: ir.map(r => parseInt(r.value)),
      name: 'IR (940nm)',
      type: 'scatter',
      mode: 'lines',
      line: {color: '#cc00cc', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'PPG Value (ADC counts)'},
    height: 400,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('ppgGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotACC(acc) {
  // Normalize time to start from 0
  const t0 = acc.length > 0 ? parseInt(acc[0].timestamp) / 1000 : 0;

  // Get ACC values
  const accX = acc.map(r => parseInt(r.accX));
  const accY = acc.map(r => parseInt(r.accY));
  const accZ = acc.map(r => parseInt(r.accZ));

  // Calculate DC offset (mean)
  const removeDC = document.getElementById('removeDC') && document.getElementById('removeDC').checked;
  const dcX = removeDC && accX.length > 0 ? accX.reduce((a,b) => a+b) / accX.length : 0;
  const dcY = removeDC && accY.length > 0 ? accY.reduce((a,b) => a+b) / accY.length : 0;
  const dcZ = removeDC && accZ.length > 0 ? accZ.reduce((a,b) => a+b) / accZ.length : 0;

  const traces = [
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: accX.map(v => v - dcX),
      name: `ACC X${removeDC ? ' (DC removed)' : ''}`,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#ff6b6b', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: accY.map(v => v - dcY),
      name: `ACC Y${removeDC ? ' (DC removed)' : ''}`,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#4ecdc4', width: 1}
    },
    {
      x: acc.map(r => parseInt(r.timestamp) / 1000 - t0),
      y: accZ.map(v => v - dcZ),
      name: `ACC Z${removeDC ? ' (DC removed)' : ''}`,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#45b7d1', width: 1}
    }
  ];

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: `Acceleration (counts${removeDC ? ', DC removed' : ''})`},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('accGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotBPM(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.bpm_q) === q && parseInt(r.bpm) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.bpm)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [0, 200],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'Heart Rate (bpm)', range: [0, 200]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('bpmGraph', traces, layout, {responsive: true, displayModeBar: false});
}

function plotSpO2(records) {
  const qualityColors = {
    0: '#cccccc',
    1: '#ff6b6b',
    2: '#ffd93d',
    3: '#6bcf7f',
    4: '#4ecdc4'
  };

  // Normalize time to start from 0
  const t0 = records.length > 0 ? parseInt(records[0].timestamp) : 0;

  const traces = [];
  const qualities = [0, 1, 2, 3, 4];

  qualities.forEach(q => {
    const filtered = records.filter(r => parseInt(r.spo2_q) === q && parseInt(r.spo2) > 0);
    if (filtered.length > 0) {
      traces.push({
        x: filtered.map(r => parseInt(r.timestamp) - t0),
        y: filtered.map(r => parseInt(r.spo2)),
        name: `Quality ${q}`,
        type: 'scatter',
        mode: 'markers+lines',
        marker: {color: qualityColors[q], size: 6},
        line: {color: qualityColors[q], width: 2}
      });
    }
  });

  // Event markers
  const events = currentData.scenario.events || [];
  events.forEach(event => {
    traces.push({
      x: [event.time - t0, event.time - t0],
      y: [75, 105],
      name: event.label,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#c5221f', width: 3, dash: 'dash'},
      showlegend: true
    });
  });

  const layout = {
    xaxis: {title: 'Time (seconds)'},
    yaxis: {title: 'SpO2 (%)', range: [75, 105]},
    height: 350,
    margin: {l: 60, r: 30, t: 10, b: 50},
    hovermode: 'x unified',
    autosize: true
  };

  Plotly.newPlot('spo2Graph', traces, layout, {responsive: true, displayModeBar: false});
}

function generateAIAnalysis(activityRecords, ppgGreen, ppgRed, ppgIR, acc, scenario) {
  // Deep statistical analysis
  const hrValues = activityRecords.map(r => parseInt(r.bpm)).filter(v => v > 0);
  const spo2Values = activityRecords.map(r => parseInt(r.spo2)).filter(v => v > 0);
  const hrQuality = activityRecords.map(r => parseInt(r.bpm_q));
  const spo2Quality = activityRecords.map(r => parseInt(r.spo2_q));

  const avgHR = hrValues.length > 0 ? Math.round(hrValues.reduce((a, b) => a + b) / hrValues.length) : 0;
  const minHR = hrValues.length > 0 ? Math.min(...hrValues) : 0;
  const maxHR = hrValues.length > 0 ? Math.max(...hrValues) : 0;
  const stdHR = hrValues.length > 1 ? Math.sqrt(hrValues.map(v => (v - avgHR)**2).reduce((a,b) => a+b) / hrValues.length).toFixed(1) : 0;

  const avgSpO2 = spo2Values.length > 0 ? Math.round(spo2Values.reduce((a, b) => a + b) / spo2Values.length) : 0;
  const minSpO2 = spo2Values.length > 0 ? Math.min(...spo2Values) : 0;
  const maxSpO2 = spo2Values.length > 0 ? Math.max(...spo2Values) : 0;

  const hrQ3_4 = hrQuality.filter(q => q >= 3).length;
  const spo2Q3_4 = spo2Quality.filter(q => q >= 3).length;
  const hrQualityRate = activityRecords.length > 0 ? (hrQ3_4 / activityRecords.length * 100).toFixed(1) : 0;
  const spo2QualityRate = activityRecords.length > 0 ? (spo2Q3_4 / activityRecords.length * 100).toFixed(1) : 0;

  // PPG raw signal analysis
  const greenValues = ppgGreen.map(r => parseInt(r.value));
  const redValues = ppgRed.map(r => parseInt(r.value));
  const irValues = ppgIR.map(r => parseInt(r.value));

  const avgGreen = greenValues.length > 0 ? Math.round(greenValues.reduce((a,b) => a+b) / greenValues.length) : 0;
  const avgRed = redValues.length > 0 ? Math.round(redValues.reduce((a,b) => a+b) / redValues.length) : 0;
  const avgIR = irValues.length > 0 ? Math.round(irValues.reduce((a,b) => a+b) / irValues.length) : 0;

  // Calculate estimated AC component (simple peak-to-peak / 2)
  const greenMax = greenValues.length > 0 ? Math.max(...greenValues) : 0;
  const greenMin = greenValues.length > 0 ? Math.min(...greenValues) : 0;
  const redMax = redValues.length > 0 ? Math.max(...redValues) : 0;
  const redMin = redValues.length > 0 ? Math.min(...redValues) : 0;
  const irMax = irValues.length > 0 ? Math.max(...irValues) : 0;
  const irMin = irValues.length > 0 ? Math.min(...irValues) : 0;

  const acGreen = (greenMax - greenMin) / 2;
  const acRed = (redMax - redMin) / 2;
  const acIR = (irMax - irMin) / 2;

  const dcGreen = avgGreen;
  const dcRed = avgRed;
  const dcIR = avgIR;

  // Calculate R ratio for SpO2
  const rRatio = (dcRed > 0 && dcIR > 0 && acIR > 0) ? ((acRed / dcRed) / (acIR / dcIR)).toFixed(3) : null;
  const estimatedSpO2 = rRatio ? Math.round(108.49 - 30.09 * rRatio - 0.03 * rRatio * rRatio) : null;

  // ACC analysis
  const accX = acc.map(r => parseInt(r.accX));
  const accY = acc.map(r => parseInt(r.accY));
  const accZ = acc.map(r => parseInt(r.accZ));
  const accMag = acc.map((r, i) => Math.sqrt(accX[i]**2 + accY[i]**2 + accZ[i]**2));
  const avgAccMag = accMag.length > 0 ? (accMag.reduce((a, b) => a + b) / accMag.length).toFixed(1) : 0;
  const maxAccMag = accMag.length > 0 ? Math.max(...accMag).toFixed(1) : 0;
  const minAccMag = accMag.length > 0 ? Math.min(...accMag).toFixed(1) : 0;

  // Build detailed analysis
  let analysis = `<div style="margin-bottom: 24px;"><strong style="font-size: 18px; color: var(--blue);">üî¨ Deep Firmware Analysis</strong></div>`;

  // === RAW SIGNAL ANALYSIS ===
  analysis += `<div style="background: var(--bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">`;
  analysis += `<div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--text);">üìä Raw PPG Signal Measurements</div>`;
  analysis += `<div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8;">`;
  analysis += `Green PPG: DC=${dcGreen.toLocaleString()} ADC, AC‚âà${acGreen.toFixed(0)} (pk-pk=${greenMax-greenMin}), AC/DC=${(acGreen/dcGreen*100).toFixed(2)}%<br>`;
  analysis += `Red PPG:   DC=${dcRed.toLocaleString()} ADC, AC‚âà${acRed.toFixed(0)} (pk-pk=${redMax-redMin}), AC/DC=${(acRed/dcRed*100).toFixed(2)}%<br>`;
  analysis += `IR PPG:    DC=${dcIR.toLocaleString()} ADC, AC‚âà${acIR.toFixed(0)} (pk-pk=${irMax-irMin}), AC/DC=${(acIR/dcIR*100).toFixed(2)}%<br>`;
  if (rRatio) {
    analysis += `<strong>R ratio = (AC_Red/DC_Red)/(AC_IR/DC_IR) = ${rRatio}</strong><br>`;
    analysis += `<strong>Estimated SpO2 = 108.49 - 30.09√ó${rRatio} - 0.03√ó${rRatio}¬≤ = ${estimatedSpO2}%</strong>`;
  }
  analysis += `</div>`;
  analysis += `</div>`;

  // === ACTIVITY RECORDS ANALYSIS ===
  analysis += `<div style="background: var(--bg); padding: 20px; border-radius: 8px; margin-bottom: 20px;">`;
  analysis += `<div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--text);">üìà Algorithm Output (activity_records.csv)</div>`;
  analysis += `<div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8;">`;
  analysis += `HR:   Avg=${avgHR} bpm, Range=[${minHR}-${maxHR}], StdDev=${stdHR} bpm, Quality‚â•3: ${hrQualityRate}%<br>`;
  analysis += `SpO2: Avg=${avgSpO2}%, Range=[${minSpO2}-${maxSpO2}], Quality‚â•3: ${spo2QualityRate}%<br>`;
  analysis += `ACC:  Magnitude avg=${avgAccMag} counts (${(avgAccMag/1024).toFixed(2)}g), range=[${minAccMag}-${maxAccMag}]<br>`;
  analysis += `Records: ${activityRecords.length} samples (1/min), Duration: ${activityRecords.length} minutes`;
  analysis += `</div>`;

  // Sample first 3 records
  if (activityRecords.length > 0) {
    analysis += `<div style="margin-top: 12px; padding: 12px; background: white; border-left: 3px solid var(--blue); font-size: 12px; font-family: monospace;">`;
    analysis += `<strong>Sample records (first 3):</strong><br>`;
    for (let i = 0; i < Math.min(3, activityRecords.length); i++) {
      const r = activityRecords[i];
      analysis += `[${i}] t=${r.timestamp}s: HR=${r.bpm} (Q=${r.bpm_q}), SpO2=${r.spo2} (Q=${r.spo2_q}), steps=${r.steps || 0}<br>`;
    }
    analysis += `</div>`;
  }
  analysis += `</div>`;

  // === CRITICAL ANALYSIS ===
  analysis += `<div style="margin: 24px 0; border-top: 2px solid var(--border); padding-top: 20px;"><strong style="font-size: 16px; color: var(--blue);">üîç Critical Algorithm Analysis</strong></div>`;

  const scenarioName = scenario.name.toLowerCase();
  let issues = [];
  let insights = [];

  // === SpO2 ANALYSIS ===
  if (avgSpO2 === 0 && estimatedSpO2 !== null) {
    issues.push({
      severity: 'critical',
      title: 'SpO2 Algorithm Rejection Despite Valid R Ratio',
      details: `RAW DATA shows R ratio = ${rRatio}, which yields SpO2 ‚âà ${estimatedSpO2}% using the polynomial.<br>
      However, <strong>FIRMWARE OUTPUT = 0% in ALL ${activityRecords.length} records</strong>.<br><br>
      <strong>Root cause diagnosis:</strong><br>
      Looking at the data flow: PPG signals are present (Green DC=${dcGreen}, Red DC=${dcRed}, IR DC=${dcIR}),
      R ratio is calculable and in valid range [0.4-3.4], yet mmt_spo2.c is rejecting all measurements.<br><br>
      <strong>Most likely causes (in order of probability):</strong><br>
      1. <code>mmt_idle_detection</code> state > ALMOST_IDLE (1): If movement detection returns ACTIVE (4),
      mmt_spo2.c line ~350 will reject SpO2. Check if ACC data is being fed via mmt_idle_detection_feed_acc().<br>
      2. Signal quality flags: Even with good R ratio, if AC amplitude < threshold or DC saturation detected,
      algorithm may reject. Green AC/DC = ${(acGreen/dcGreen*100).toFixed(2)}% (expect 1-3% for good signal).<br>
      3. Reporting rate issue: Default mmt_process_fxi uses 30-min reporting. With 1-hour test, you get max 2 reports.
      Solution: call mmt_process_fxi_set_reporting_rate_spo2(60) for 1-min reports.`
    });
  } else if (avgSpO2 > 0 && estimatedSpO2 !== null && Math.abs(avgSpO2 - estimatedSpO2) > 5) {
    insights.push({
      title: 'SpO2 Measurement vs Raw R Ratio Discrepancy',
      details: `Firmware reports avg SpO2 = ${avgSpO2}%, but raw R ratio ${rRatio} suggests ~${estimatedSpO2}%.<br>
      Difference: ${Math.abs(avgSpO2 - estimatedSpO2).toFixed(1)}%.<br><br>
      This is <strong>${Math.abs(avgSpO2 - estimatedSpO2) > 10 ? 'ABNORMAL' : 'acceptable'}</strong>.
      Firmware likely applies additional filtering, perfusion quality checks, and temporal averaging
      that aren't visible in this 1Hz-downsampled view. Original 32Hz data may show more variability.`
    });
  }

  // === MOTION ANALYSIS ===
  const isMotionScenario = scenarioName.includes('walking') || scenarioName.includes('running') || scenarioName.includes('movement');
  if (isMotionScenario) {
    const motionLevel = avgAccMag > 1500 ? 'INTENSE' : avgAccMag > 1200 ? 'MODERATE' : 'MILD';
    insights.push({
      title: `Motion Artifact Analysis: ${motionLevel} Activity Detected`,
      details: `ACC magnitude: avg=${avgAccMag} (${(avgAccMag/1024).toFixed(2)}g), peak=${maxAccMag} (${(maxAccMag/1024).toFixed(2)}g).<br><br>
      <strong>HR algorithm performance:</strong> ${hrQualityRate}% good quality (Q‚â•3).<br>
      ${hrQualityRate > 50
        ? `‚úì GOOD tolerance to motion. Algorithm is likely using ACC signal for motion artifact subtraction
           or spectral filtering. This is expected behavior for mmt_hrm_process with motion compensation enabled.`
        : `‚ö† POOR motion tolerance. HR quality degrades significantly during movement.
           Walking cadence (1.8-2.2 Hz) overlaps with HR band (1-3 Hz), making separation difficult.
           Algorithm may need better ACC-based filtering or FFT spectral subtraction.`}<br><br>
      <strong>SpO2 algorithm performance:</strong> ${spo2QualityRate}% good quality.<br>
      ${spo2QualityRate < 30
        ? `‚úì CORRECT rejection during motion. SpO2 is unreliable with motion artifacts because Red and IR
           are affected unequally, corrupting the R ratio. Algorithm correctly rejects contaminated data.`
        : `‚ö† Unexpectedly HIGH SpO2 quality during motion. Either: (1) motion is milder than expected,
           (2) algorithm motion detection threshold is too lenient (may produce false readings),
           (3) test data doesn't accurately simulate motion artifacts.`}`
    });
  }

  // === HR VARIABILITY ANALYSIS ===
  if (stdHR > 0) {
    const cvHR = (stdHR / avgHR * 100).toFixed(1);
    if (scenarioName.includes('af') || scenarioName.includes('fibrillation')) {
      insights.push({
        title: 'Atrial Fibrillation: Rhythm Irregularity Detected',
        details: `HR variability (std dev) = ${stdHR} bpm, CV = ${cvHR}%.<br><br>
        For AF, coefficient of variation >15-20% is pathognomonic of irregular ventricular response.
        Current CV = ${cvHR}%.<br>
        ${parseFloat(cvHR) > 15
          ? `‚úì HIGH variability confirms irregular rhythm consistent with AF. Algorithm is correctly
             detecting the chaotic RR intervals. Each beat's amplitude should also vary with preceding RR
             (short RR ‚Üí low amplitude, long RR ‚Üí high amplitude due to varying diastolic filling).`
          : `‚ö† LOW variability for AF scenario. Expected CV >15%. Possible causes:<br>
             1. Synthetic signal generation isn't producing enough RR variability<br>
             2. Algorithm is over-smoothing/averaging, masking true irregularity<br>
             3. 1-minute averaging in activity records conceals beat-to-beat chaos`}`
      });
    } else if (!scenarioName.includes('walking') && !scenarioName.includes('running') && parseFloat(cvHR) > 15) {
      issues.push({
        severity: 'warning',
        title: 'Unexpectedly High HR Variability in Non-AF Scenario',
        details: `HR std dev = ${stdHR} bpm, CV = ${cvHR}% (>15% suggests arrhythmia).<br><br>
        In a ${scenario.name} scenario, such high variability is unusual unless:<br>
        1. Scenario includes premature beats (PVCs/SVPCs) causing intermittent HR jumps<br>
        2. Signal quality is poor, causing false detections<br>
        3. Algorithm is unstable (oscillating between different peak detection thresholds)<br><br>
        Check individual records for outliers or systematic patterns.`
      });
    }
  }

  // === CARDIAC ARREST DETECTION ===
  if (scenarioName.includes('cardiac arrest') || scenarioName.includes('vf') || scenarioName.includes('asystole') || scenarioName.includes('pea')) {
    if (avgHR === 0 || hrValues.length === 0) {
      insights.push({
        title: 'Cardiac Arrest: Correct Pulseless Detection',
        details: `‚úì Algorithm correctly detects absence of mechanical pulse.<br>
        HR output = 0 bpm across all ${activityRecords.length} records.<br><br>
        PPG signal analysis:<br>
        ‚Ä¢ Green AC component ‚âà ${acGreen.toFixed(0)} (peak-to-peak ${greenMax-greenMin})<br>
        ‚Ä¢ Expected in VF/asystole: AC < 1% of normal (typically <500 ADC counts)<br>
        ${acGreen < 500
          ? `‚úì AC amplitude is near-zero, confirming flat signal (no pulsatile component).`
          : `‚ö† AC amplitude seems higher than expected for cardiac arrest. Possible causes:<br>
             (1) Residual coarse VF oscillations in early phase<br>
             (2) Noise artifacts being interpreted as residual signal<br>
             (3) Synthetic data may not accurately model complete signal loss`}<br><br>
        <strong>Clinical requirement:</strong> Alarm should trigger after >40s of no detectable pulse.
        Test duration: ${activityRecords.length * 60}s. Algorithm must maintain 0 HR throughout.`
      });
    } else {
      issues.push({
        severity: 'critical',
        title: 'FALSE PULSE DETECTION DURING CARDIAC ARREST',
        details: `<strong style="color: var(--red);">CRITICAL BUG:</strong> Algorithm reports HR = ${avgHR} bpm during cardiac arrest scenario.<br><br>
        This is a <strong>life-threatening false negative</strong>. In real use, this would prevent cardiac arrest alarm
        from triggering, delaying CPR and reducing survival odds.<br><br>
        <strong>Evidence from data:</strong><br>
        ‚Ä¢ PPG AC component: Green=${acGreen.toFixed(0)}, Red=${acRed.toFixed(0)}, IR=${acIR.toFixed(0)}<br>
        ‚Ä¢ If AC > noise floor, algorithm may be detecting artifacts as cardiac pulses<br><br>
        <strong>Root cause hypothesis:</strong><br>
        1. Peak detection threshold too lenient (picking up noise as beats)<br>
        2. Synthetic cardiac arrest data doesn't model signal loss correctly (AC should be <100)<br>
        3. Algorithm lacks "consecutive missed beats" counter (should trigger alarm after 40-60s no pulse)<br><br>
        <strong>Required fix:</strong> Implement stricter pulse validation. Check:<br>
        ‚Ä¢ mmt_hrm_process.c: minimum AC amplitude threshold<br>
        ‚Ä¢ Consecutive beat timeout logic<br>
        ‚Ä¢ Firmware should output HR=0 if no valid beats detected for >10 seconds`
      });
    }
  }

  // === PERFUSION ANALYSIS ===
  const perfusionIndex = dcGreen > 0 ? (acGreen / dcGreen * 100).toFixed(2) : 0;
  if (parseFloat(perfusionIndex) < 0.4) {
    issues.push({
      severity: 'warning',
      title: 'Low Perfusion Index Detected',
      details: `Perfusion Index (PI) = AC/DC = ${perfusionIndex}% (normal >1%).<br><br>
      <strong>Signal characteristics:</strong><br>
      ‚Ä¢ Green DC = ${dcGreen.toLocaleString()} ADC (baseline absorption)<br>
      ‚Ä¢ Green AC ‚âà ${acGreen.toFixed(0)} ADC (pulsatile component)<br>
      ‚Ä¢ AC/DC ratio = ${perfusionIndex}%<br><br>
      Low PI indicates poor peripheral perfusion. Common in:<br>
      1. <strong>Vasoconstriction:</strong> Hypothermia, shock, or hypovolemia scenarios<br>
      2. <strong>Low cardiac output:</strong> Heart failure, cardiac arrest<br>
      3. <strong>Poor sensor contact:</strong> But this is synthetic data, so unlikely<br><br>
      <strong>Impact on algorithms:</strong><br>
      ‚Ä¢ Low SNR makes pulse detection harder ‚Üí reduced HR quality<br>
      ‚Ä¢ SpO2 may be rejected due to insufficient AC amplitude<br>
      ‚Ä¢ Firmware may compensate by increasing LED power (check led% in PPG data)<br><br>
      For scenario "${scenario.name}", this ${scenarioName.includes('hypothermia') || scenarioName.includes('shock') || scenarioName.includes('heart failure')
        ? 'IS EXPECTED and correctly modeled'
        : 'may indicate over-aggressive vasoconstriction in synthetic signal generation'}.`
    });
  }

  // === RENDER ISSUES AND INSIGHTS ===
  analysis += `<div style="margin-top: 24px;">`;

  if (issues.length > 0) {
    issues.forEach(issue => {
      const bgColor = issue.severity === 'critical' ? 'var(--red-bg)' : 'var(--orange-bg)';
      const borderColor = issue.severity === 'critical' ? 'var(--red)' : 'var(--orange)';
      const icon = issue.severity === 'critical' ? 'üî¥' : '‚ö†Ô∏è';

      analysis += `<div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; padding: 20px; margin-bottom: 16px; border-radius: 8px;">`;
      analysis += `<div style="font-weight: 600; font-size: 15px; margin-bottom: 10px; color: ${borderColor};">${icon} ${issue.title}</div>`;
      analysis += `<div style="font-size: 13px; line-height: 1.8; color: var(--text);">${issue.details}</div>`;
      analysis += `</div>`;
    });
  }

  if (insights.length > 0) {
    insights.forEach(insight => {
      analysis += `<div style="background: var(--blue-bg); border-left: 4px solid var(--blue); padding: 20px; margin-bottom: 16px; border-radius: 8px;">`;
      analysis += `<div style="font-weight: 600; font-size: 15px; margin-bottom: 10px; color: var(--blue);">üí° ${insight.title}</div>`;
      analysis += `<div style="font-size: 13px; line-height: 1.8; color: var(--text);">${insight.details}</div>`;
      analysis += `</div>`;
    });
  }

  if (issues.length === 0 && insights.length === 0) {
    analysis += `<div style="background: var(--green-bg); border-left: 4px solid var(--green); padding: 20px; border-radius: 8px;">`;
    analysis += `<div style="font-weight: 600; font-size: 15px; margin-bottom: 10px; color: var(--green);">‚úì No Critical Issues Detected</div>`;
    analysis += `<div style="font-size: 13px; color: var(--text);">Algorithm outputs appear consistent with scenario expectations and raw signal measurements.</div>`;
    analysis += `</div>`;
  }

  analysis += `</div>`;

  // === SUMMARY ===
  analysis += `<div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%); border-radius: 8px; border: 1px solid var(--border);">`;
  analysis += `<div style="font-weight: 600; margin-bottom: 12px; color: var(--text);">üìã Analysis Summary</div>`;
  analysis += `<div style="font-size: 13px; line-height: 1.8; color: var(--text2);">`;
  analysis += `This analysis examined ${activityRecords.length} activity records, ${ppgGreen.length} PPG samples, and ${acc.length} ACC samples.<br>`;
  analysis += `Raw PPG signals show R ratio = ${rRatio || 'N/A'} ‚Üí estimated SpO2 ‚âà ${estimatedSpO2 || 'N/A'}%.<br>`;
  analysis += `Firmware output: HR avg ${avgHR} bpm, SpO2 avg ${avgSpO2}%.<br>`;
  analysis += `<strong>${issues.length} critical issue${issues.length !== 1 ? 's' : ''}</strong> and <strong>${insights.length} insight${insights.length !== 1 ? 's' : ''}</strong> identified.`;
  analysis += `</div></div>`;

  return analysis;
}

function synchronizeGraphs() {
  const graphIds = ['ppgGraph', 'accGraph', 'bpmGraph', 'spo2Graph'];

  graphIds.forEach(id => {
    const graph = document.getElementById(id);

    graph.on('plotly_relayout', (eventdata) => {
      if (eventdata['xaxis.range[0]'] !== undefined && eventdata['xaxis.range[1]'] !== undefined) {
        const xrange = [eventdata['xaxis.range[0]'], eventdata['xaxis.range[1]']];
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.range': xrange});
          }
        });
      } else if (eventdata['xaxis.autorange'] === true) {
        graphIds.forEach(otherId => {
          if (otherId !== id) {
            Plotly.relayout(otherId, {'xaxis.autorange': true});
          }
        });
      }
    });
  });
}
</script>
</body>
</html>
